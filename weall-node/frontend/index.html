<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WeAll Node Dashboard</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #000;
        color: #fff;
    }
    nav {
        display: flex;
        justify-content: space-around;
        background: #111;
        padding: 10px 0;
    }
    nav button {
        background: #222;
        color: #fff;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
    }
    nav button.active { background: #555; }
    section { display: none; padding: 20px; min-height: calc(100vh - 50px); }
    section.active { display: block; }
    .post, .proposal, .dispute {
        border: 1px solid #aaa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        background: #111;
    }
    .actions button { margin-right: 5px; }
</style>
</head>
<body>

<nav>
    <button onclick="showPage('feed')" id="tab-feed" class="active">Feed</button>
    <button onclick="showPage('governance')" id="tab-governance">Governance</button>
    <button onclick="showPage('profile')" id="tab-profile">Profile</button>
</nav>

<!-- Feed Page -->
<section id="feed" class="active">
    <h2>Posts Feed</h2>
    <div id="posts_feed"></div>
</section>

<!-- Governance Page -->
<section id="governance">
    <h2>Proposals</h2>
    <div id="proposals_feed"></div>
    <h2>Disputes</h2>
    <div id="disputes_feed"></div>
</section>

<!-- Profile Page -->
<section id="profile">
    <h2>Profile</h2>
    <div>
        <input id="profile_user_id" placeholder="User ID">
        <button onclick="loadProfile()">Load Profile</button>
    </div>
    <div id="profile_info"></div>
    <h3>Messages</h3>
    <div id="messages_result"></div>
</section>

<script>
const API_BASE = "http://localhost:8000";

// ---------------- Navigation ----------------
function showPage(page) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(page).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${page}`).classList.add('active');
}

// ---------------- Feed ----------------
async function loadPosts() {
    const posts = await fetch(`${API_BASE}/show_posts`).then(r => r.json());
    const feedDiv = document.getElementById("posts_feed");
    feedDiv.innerHTML = "";
    for (const [pid, post] of Object.entries(posts)) {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
            <strong>${post.user}</strong>: ${post.content}<br>
            Likes: ${post.likes}
            <div class="actions">
                <button onclick="likePost(${pid})">‚ù§Ô∏è</button>
                <button onclick="commentPost(${pid})">üí¨</button>
            </div>
        `;
        feedDiv.appendChild(div);
    }
}

async function likePost(post_id) {
    const user_id = prompt("User ID to like:");
    await fetch(`${API_BASE}/like_post`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, post_id })
    });
    loadPosts();
}

async function commentPost(post_id) {
    const user_id = prompt("User ID:");
    const content = prompt("Comment:");
    await fetch(`${API_BASE}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, post_id, content })
    });
    loadPosts();
}

// ---------------- Governance ----------------
async function loadProposals() {
    const proposals = await fetch(`${API_BASE}/show_proposals`).then(r => r.json());
    const feed = document.getElementById("proposals_feed");
    feed.innerHTML = "";
    for (const [pid, prop] of Object.entries(proposals)) {
        const div = document.createElement("div");
        div.className = "proposal";
        div.innerHTML = `
            <strong>${prop.title}</strong> | Status: ${prop.status}<br>
            <button onclick="voteProposal(${pid}, 'yes')">Vote YES</button>
            <button onclick="voteProposal(${pid}, 'no')">Vote NO</button>
        `;
        feed.appendChild(div);
    }
}

async function voteProposal(pid, option) {
    const user_id = prompt("User ID:");
    await fetch(`${API_BASE}/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, target_id: pid, vote_option: option })
    });
    loadProposals();
}

async function loadDisputes() {
    const disputes = await fetch(`${API_BASE}/show_disputes`).then(r => r.json());
    const feed = document.getElementById("disputes_feed");
    feed.innerHTML = "";
    for (const [did, d] of Object.entries(disputes)) {
        const div = document.createElement("div");
        div.className = "dispute";
        div.innerHTML = `
            Post: ${d.target_post} | Status: ${d.status}<br>
            <button onclick="jurorVote(${did}, 'approve')">Approve</button>
            <button onclick="jurorVote(${did}, 'reject')">Reject</button>
        `;
        feed.appendChild(div);
    }
}

async function jurorVote(dispute_id, option) {
    const juror_id = prompt("User ID:");
    await fetch(`${API_BASE}/juror_vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ juror_id, dispute_id, vote_option: option })
    });
    loadDisputes();
}

// ---------------- Profile ----------------
async function loadProfile() {
    const user_id = document.getElementById("profile_user_id").value;
    const posts = await fetch(`${API_BASE}/list_user_posts/${user_id}`).then(r => r.json());
    const profileDiv = document.getElementById("profile_info");
    profileDiv.innerHTML = `Posts: ${JSON.stringify(posts.posts, null, 2)}`;
    const messages = await fetch(`${API_BASE}/read_messages/${user_id}`).then(r => r.json());
    const msgDiv = document.getElementById("messages_result");
    msgDiv.innerHTML = "";
    messages.forEach(m => {
        const div = document.createElement("div");
        div.innerText = `From ${m.from}: ${m.text}`;
        msgDiv.appendChild(div);
    });
}

// ---------------- Auto-refresh feed ----------------
setInterval(() => {
    if(document.getElementById('feed').classList.contains('active')) loadPosts();
    if(document.getElementById('governance').classList.contains('active')) {
        loadProposals();
        loadDisputes();
    }
}, 5000);

// Initial load
loadPosts();
loadProposals();
loadDisputes();
</script>

</body>
</html>
