<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WeAll — Operator Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      background:#000;
      color:#fff;
      font-family:Arial, sans-serif;
      margin:0;
      padding:0;
    }
    header {
      background:#111;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    header h2 { margin:0; font-size:1.2em; }
    header a {
      color:#2ecc71;
      text-decoration:none;
      font-weight:bold;
      font-size:0.9em;
    }
    .container {
      max-width:800px;
      margin:auto;
      padding:20px;
    }
    .card {
      background:#111;
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 0 5px #222;
    }
    h3 { color:#2ecc71; margin-top:0; }
    .stat { display:flex; justify-content:space-between; margin-bottom:6px; }
    .btn {
      display:inline-block;
      background:#2ecc71;
      color:#000;
      border:none;
      border-radius:8px;
      padding:8px 14px;
      font-weight:bold;
      cursor:pointer;
    }
    .btn.small { padding:6px 10px; font-size:0.9em; }
    .btn:hover { background:#27ae60; }
    .status-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      display:inline-block;
      margin-right:6px;
    }
    .ok { background:#2ecc71; }
    .fail { background:#e74c3c; }
    .neutral { background:#999; }
    .scroll-list {
      max-height:200px;
      overflow-y:auto;
      font-size:0.9em;
      background:#000;
      border-radius:8px;
      padding:10px;
      border:1px solid #222;
    }
  </style>
</head>
<body>
  <header>
    <h2>Operator Dashboard</h2>
    <a href="index.html">← Back to Feed</a>
  </header>

  <div class="container">
    <!-- IPFS Health -->
    <div class="card" id="ipfsCard">
      <h3>IPFS Status</h3>
      <div id="ipfsStatus" class="stat"><span>Checking connection...</span></div>
      <button class="btn small" onclick="checkIPFS()">Refresh</button>
    </div>

    <!-- P2P / Node Health -->
    <div class="card" id="p2pCard">
      <h3>P2P Network</h3>
      <div id="p2pPeers" class="scroll-list">Loading peers...</div>
      <button class="btn small" onclick="checkP2P()">Refresh Peers</button>
    </div>

    <!-- Pinning Queue -->
    <div class="card" id="pinCard">
      <h3>Pinning Queue</h3>
      <div id="pinList" class="scroll-list">Loading queue...</div>
      <button class="btn small" onclick="refreshQueue()">Refresh Queue</button>
    </div>

    <!-- Chain Info -->
    <div class="card" id="chainCard">
      <h3>Chain Info</h3>
      <div class="stat"><strong>Current Height:</strong><span id="chainHeight">Loading...</span></div>
      <div class="stat"><strong>Genesis Safeguard:</strong><span id="gsmStatus">Loading...</span></div>
      <button class="btn small" onclick="refreshChain()">Refresh Chain</button>
    </div>
  </div>

  <script>
    async function checkIPFS() {
      const el = document.getElementById('ipfsStatus');
      el.innerHTML = '<span>Checking connection...</span>';
      try {
        const res = await fetch('/health/ipfs');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Error');
        const color = data.online ? 'ok' : 'fail';
        el.innerHTML = \`<span class="status-dot \${color}"></span> IPFS \${data.online ? 'Online' : 'Offline'} — Peers: \${data.peers || 0}\`;
      } catch (err) {
        el.innerHTML = '<span class="status-dot fail"></span> IPFS Error';
      }
    }

    async function checkP2P() {
      const el = document.getElementById('p2pPeers');
      el.textContent = 'Refreshing...';
      try {
        const res = await fetch('/health/p2p');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Error');
        if (!data.peers || !data.peers.length) {
          el.textContent = 'No active peers.';
        } else {
          el.innerHTML = data.peers.map(p => \`<div>• \${p.id} — \${p.addr}</div>\`).join('');
        }
      } catch (err) {
        el.textContent = '⚠️ ' + err.message;
      }
    }

    async function refreshQueue() {
      const el = document.getElementById('pinList');
      el.textContent = 'Refreshing...';
      try {
        const res = await fetch('/pinning/queue');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Error');
        if (!data.length) {
          el.textContent = 'Pin queue empty.';
        } else {
          el.innerHTML = data.map(p => \`<div>\${p.cid} — Status: \${p.status}</div>\`).join('');
        }
      } catch (err) {
        el.textContent = '⚠️ ' + err.message;
      }
    }

    async function refreshChain() {
      const h = document.getElementById('chainHeight');
      const g = document.getElementById('gsmStatus');
      h.textContent = '...';
      g.textContent = '...';
      try {
        const res = await fetch('/chain/height');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Error');
        h.textContent = data.height;
      } catch (err) {
        h.textContent = '⚠️';
      }
      try {
        const res = await fetch('/chain/status');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Error');
        g.textContent = data.gsm_active ? 'Active' : 'Inactive';
      } catch (err) {
        g.textContent = '⚠️';
      }
    }

    // Auto-init when page loads
    checkIPFS();
    checkP2P();
    refreshQueue();
    refreshChain();
  </script>
  <script src="/static/footer.js"></script>
</body>
</html>
