<!doctype html>
<html lang="en">
<head>
  <base href="/frontendtendtend/">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WeAll</title>
  <style>
    :root { --bg:#f7f7fa; --card:#fff; --text:#1f2937; --muted:#6b7280; --brand:#2563eb; --ok:#16a34a; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .hero{display:flex;flex-direction:column;align-items:center;margin:56px 0 32px}
    .title{font-size:52px;font-weight:800;color:var(--brand);letter-spacing:.3px;margin:0 0 8px}
    .tag{color:var(--muted);margin:0 0 24px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer}
    .btn.blue{background:var(--brand);color:#fff}
    .btn.green{background:var(--ok);color:#fff}
    .btn.ghost{background:#e5e7eb;color:#111827}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin:10px 0 22px}
    .pill{padding:8px 12px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:600}
    .card{background:var(--card);border-radius:16px;padding:18px 18px;box-shadow:0 6px 18px rgba(0,0,0,.05);margin:12px 0}
    .card h2{margin:0 0 8px}
    .muted{color:var(--muted)}
    .input{width:100%;padding:12px 12px;border:1px solid #e5e7eb;border-radius:10px;outline:none}
    .stack{display:flex;flex-direction:column;gap:12px}
    .tabs{position:sticky;bottom:0;background:var(--bg);display:flex;gap:18px;justify-content:center;padding:12px}
    .tab{padding:10px 18px;border-radius:12px}
    .tab.active{background:#e5e7eb}
    .right{display:flex;gap:10px;align-items:center}
    .badge{font-weight:700}
    .center{display:flex;justify-content:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    textarea.input{resize:vertical}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- Unauthed landing -->
    <div id="landing">
      <div class="hero">
        <h1 class="title">WeAll</h1>
        <p class="tag">Decentralized coordination, human-first.</p>
        <div class="row">
          <button class="btn blue" id="btnLogin">Login</button>
          <button class="btn green" id="btnSignup">Sign Up</button>
        </div>
        <p class="muted mono">API: <span id="apiBase"></span></p>
      </div>

      <!-- Signup / Login panels -->
      <div class="card" id="panelSignup" style="display:none">
        <h2>Sign Up (Tier-1 Email)</h2>
        <div class="stack">
          <input class="input" id="suEmail" placeholder="your@email.com" inputmode="email" />
          <div class="row">
            <button class="btn green" id="btnRequestCode">Request Code</button>
            <button class="btn ghost" id="btnBack1">Back</button>
          </div>
          <div id="codeArea" style="display:none" class="stack">
            <input class="input" id="suCode" placeholder="6-digit code" inputmode="numeric" maxlength="6"/>
            <div class="row">
              <button class="btn blue" id="btnVerifyCode">Verify & Login</button>
              <button class="btn ghost" id="btnResend">Resend</button>
            </div>
            <p class="muted">Code is sent from <span class="mono">WeAll &lt;weall.verify@gmail.com&gt;</span> (logged to server console in dev).</p>
          </div>
        </div>
      </div>

      <div class="card" id="panelLogin" style="display:none">
        <h2>Login (existing ID)</h2>
        <div class="stack">
          <input class="input" id="liEmail" placeholder="user id (email)"/>
          <div class="row">
            <button class="btn blue" id="btnDoLogin">Login</button>
            <button class="btn ghost" id="btnBack2">Back</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Authed app -->
    <div id="authed" style="display:none">
      <div class="topbar">
        <div class="pill">WeAll</div>
        <div class="right">
          <span id="who" class="muted"></span>
          <span class="badge" id="pohBadge"></span>
          <button class="btn ghost" id="btnLogout">Logout</button>
        </div>
      </div>

      <!-- FEED -->
      <div id="viewFeed">
        <div class="card">
          <h2>Feed</h2>
          <div class="stack">
            <textarea class="input" rows="3" id="postText" placeholder="Share something…"></textarea>
            <div class="row">
              <button class="btn green" id="btnPost">Post</button>
              <button class="btn ghost" id="btnRefreshFeed">Refresh</button>
            </div>
          </div>
        </div>

        <!-- Verification panel (Tier-2 / Tier-3) -->
        <div class="card" id="verifyPanel" style="margin-top:12px">
          <h2>Verification</h2>
          <div class="stack">
            <div class="row" style="flex-wrap:nowrap">
              <input class="input" id="tier2Evidence" placeholder="Tier-2: link to selfie or doc (optional)"/>
              <button class="btn blue" id="btnTier2">Apply Tier-2</button>
            </div>
            <div class="row" style="flex-wrap:nowrap">
              <input class="input" id="tier3Video" placeholder="Tier-3: link to short video proof"/>
              <button class="btn blue" id="btnTier3">Apply Tier-3</button>
            </div>
            <small class="muted">Auto-approve while user count is low; juror flow activates as the network grows.</small>
          </div>
        </div>

        <div id="feedList"></div>
      </div>

      <!-- GOVERNANCE (placeholder) -->
      <div id="viewGov" style="display:none">
        <div class="card"><h2>Governance</h2>
          <p class="muted">Tier-3 quorum ≥ 60%; Yes &gt; 50% among quorum (from config).</p>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="viewProfile" style="display:none">
        <div class="card"><h2>Profile</h2>
          <p><strong>User:</strong> <span id="pfUser"></span></p>
          <p><strong>PoH Level:</strong> <span id="pfPoh"></span></p>
          <p><strong>NFT Minted:</strong> <span id="pfNft"></span></p>
        </div>
      </div>

      <div class="tabs center">
        <button class="tab active" data-tab="feed">Feed</button>
        <button class="tab" data-tab="gov">Governance</button>
        <button class="tab" data-tab="profile">Profile</button>
      </div>
    </div>
  </div>

  <script>
    // ----------- Config -----------
    const API = location.origin;
    document.getElementById("apiBase").textContent = API;

    // Prefer modern endpoints; fall back to legacy if 404
    const PATHS = {
      requestTier1: "/poh/request-tier1",
      verifyTier1: "/poh/verify-tier1",
      contentFeed: "/content/feed",
      contentPost: "/content/post",
      legacyFeed: "/show_posts",
      legacyUserFeed: (uid) => `/list_user_posts/${encodeURIComponent(uid)}`
    };

    const $ = (id) => document.getElementById(id);
    const state = {
      user: localStorage.getItem("weall_user") || "",
      poh: Number(localStorage.getItem("weall_poh") || "0"),
      nftMinted: localStorage.getItem("weall_nft") === "1",
      useLegacyFeed: false,
    };

    function saveSession() {
      localStorage.setItem("weall_user", state.user);
      localStorage.setItem("weall_poh", String(state.poh));
      localStorage.setItem("weall_nft", state.nftMinted ? "1" : "0");
    }

    function show(id){ ["landing","authed"].forEach(x=>$(x).style.display = (x===id)?"block":"none"); }
    function showTab(which){
      for (const v of ["viewFeed","viewGov","viewProfile"]) $(v).style.display = "none";
      const map = {feed:"viewFeed", gov:"viewGov", profile:"viewProfile"};
      $(map[which]).style.display = "block";
      document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===which));
    }

    // ----------- Session/UI boot -----------
    function renderAuthedBar() {
      $("who").textContent = state.user || "";
      $("pohBadge").textContent = `PoH: ${state.poh}`;
      $("pfUser").textContent = state.user || "";
      $("pfPoh").textContent = String(state.poh);

    async function detectFeedMode() {
      try {
        const r = await fetch(API + PATHS.contentFeed);
        if (r.status === 404) state.useLegacyFeed = true;
      } catch { state.useLegacyFeed = true; }
    }

    async function refreshFeed() {
      const list = $("feedList");
      list.innerHTML = "";
      try {
        let items = [];
        if (!state.useLegacyFeed) {
          const r = await fetch(API + PATHS.contentFeed);
          if (r.status === 404) { state.useLegacyFeed = true; return refreshFeed(); }
          items = await r.json();
        } else {
          const r = await fetch(API + PATHS.legacyUserFeed(state.user));
          items = await r.json();
        }

        if (!Array.isArray(items)) items = items.items || [];
        if (items.length === 0) {
          list.innerHTML = `<div class="card"><span class="muted">No posts yet.</span></div>`;
          return;
        }
        for (const it of items) {
          const author = it.author || it.user || "system";
          const text = it.text || it.message || JSON.stringify(it);
          const when = it.ts ? new Date(it.ts*1000) : new Date();
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `<div style="display:flex;justify-content:space-between">
              <strong>${author}</strong>
              <span class="muted" style="font-size:12px">${when.toLocaleString()}</span>
            </div>
            <div style="margin-top:6px">${escapeHtml(text)}</div>`;
          list.appendChild(div);
        }
      } catch (e) {
        list.innerHTML = `<div class="card"><span class="muted">Failed to load feed.</span></div>`;
      }
    }

    async function postMessage() {
      const text = $("postText").value.trim();
      if (!text) return alert("Type something to post.");
      try {
        if (!state.useLegacyFeed) {
          const r = await fetch(API + PATHS.contentPost, {
            method:"POST",
            headers:{"content-type":"application/json"},
            body: JSON.stringify({ author: state.user, text })
          });
          if (r.status === 404) {
            state.useLegacyFeed = true;
          } else if (!r.ok) {
            const t = await r.text();
            throw new Error(t || r.statusText);
          }
        } else {
          // Legacy create endpoint not implemented—UI stays responsive.
        }
        $("postText").value = "";
        await refreshFeed();
      } catch (e) {
        alert("Post failed: " + (e.message || e));
      }
    }

    // ----------- Email/Tier-1 flow -----------
    async function requestCode(email) {
      const r = await fetch(API + PATHS.requestTier1, {
        method:"POST",
        headers:{"content-type":"application/json"},
        body: JSON.stringify({ user: email, email })
      });
      if (!r.ok) throw new Error(await r.text());
      return true;
    }
    async function verifyCode(email, code) {
      const r = await fetch(API + PATHS.verifyTier1, {
        method:"POST",
        headers:{"content-type":"application/json"},
        body: JSON.stringify({ user: email, code: String(code || "").trim() })
      });
      if (!r.ok) throw new Error(await r.text());
      const out = await r.json(); // {ok:true, tier/poh_level:1, nft_minted:bool}
      return out;
    }

    // ----------- Tier-2 / Tier-3 actions -----------
    async function applyTier2() {
      const evidence = ($("tier2Evidence").value || "").trim() || "selfie";
      if (!state.user) return alert("Login first.");
      const r = await fetch(API + "/poh/tier2", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ user: state.user, evidence })
      });
      const out = await r.json().catch(()=>({}));
      if (!r.ok || out.ok === false) return alert("Tier-2 failed: " + (out.error || r.statusText));
      alert("Tier-2 OK: " + (out.status || "approved"));
      // Optionally bump visible PoH if returned
      if (typeof out.tier === "number" && out.tier > state.poh) {
        state.poh = out.tier; saveSession(); renderAuthedBar();
      }
    }

    async function applyTier3() {
      const video_proof = ($("tier3Video").value || "").trim() || "video";
      if (!state.user) return alert("Login first.");
      const r = await fetch(API + "/poh/tier3", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ user: state.user, video_proof })
      });
      const out = await r.json().catch(()=>({}));
      if (!r.ok || out.ok === false) return alert("Tier-3 failed: " + (out.error || r.statusText));
      alert("Tier-3 OK: " + (out.status || "approved"));
      if (typeof out.tier === "number" && out.tier > state.poh) {
        state.poh = out.tier; saveSession(); renderAuthedBar();
      }
    }

    // ----------- Small helpers -----------
    function escapeHtml(s){ return s.replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])) }

    // ----------- Wire up -----------
    $("btnSignup").onclick = () => { $("panelLogin").style.display="none"; $("panelSignup").style.display="block"; };
    $("btnLogin").onclick  = () => { $("panelSignup").style.display="none"; $("panelLogin").style.display="block"; };
    $("btnBack1").onclick = $("btnBack2").onclick = () => { $("panelSignup").style.display="none"; $("panelLogin").style.display="none"; };

    $("btnRequestCode").onclick = async () => {
      const email = $("suEmail").value.trim();
      if (!email) return alert("Enter an email.");
      try {
        await requestCode(email);
        $("codeArea").style.display = "block";
        alert("Code sent. Check your email.");
      } catch(e){ alert("Request failed: " + (e.message||e)); }
    };
    $("btnResend").onclick = () => $("btnRequestCode").onclick();

    $("btnVerifyCode").onclick = async () => {
      const email = $("suEmail").value.trim();
      const code = $("suCode").value.trim();
      if (!email || !code) return alert("Enter email and code.");
      try {
        const out = await verifyCode(email, code);
        state.user = email;
        state.poh = Number(out.poh_level ?? out.tier ?? 1);
        state.nftMinted = !!out.nft_minted;
        (function(){var e=document.getElementById("pfNft"); if(e){e.textContent=state.nftMinted?"Yes":"No";}})();
        saveSession();
        await afterLogin();
      } catch(e){ alert("Verification failed: " + (e.message||e)); }
    };

    $("btnDoLogin").onclick = async () => {
      const email = $("liEmail").value.trim();
      if (!email) return alert("Enter user id.");
      state.user = email;
      state.poh = Number(localStorage.getItem("weall_poh") || "1");
      saveSession();
      await afterLogin();
    };

    $("btnLogout").onclick = () => {
      state.user = ""; state.poh = 0; state.nftMinted = false;
      saveSession();
      show("landing");
    };

    document.querySelectorAll(".tab").forEach(t => t.onclick = () => showTab(t.dataset.tab));
    $("btnRefreshFeed").onclick = refreshFeed;
    $("btnPost").onclick = postMessage;

    // New: Verification buttons
    (document.getElementById("btnTier2")||{}).onclick = applyTier2;
    (document.getElementById("btnTier3")||{}).onclick = applyTier3;

    async function afterLogin() {
      renderAuthedBar();
      show("authed");
      showTab("feed");
      await detectFeedMode();
      await refreshFeed();
    }

    // Boot
    (async () => {
      if (state.user) { await afterLogin(); } else { show("landing"); }
    })();
  </script>
</body>
</html>
