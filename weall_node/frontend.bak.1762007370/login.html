<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Login & Onboarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="/session.js"></script>
  <script src="/wallet.js"></script>
  <style>
    .step { display:none }
    .step.active { display:block }
    .hint { font-size:12px; color:var(--muted); margin-top:6px }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .ok { color: var(--accent) } .bad { color: var(--danger) }
  </style>
</head>
<body>
  <main style="min-height:100dvh;display:grid;place-items:center;padding:24px">
    <div class="wa-card" style="width:min(560px,92vw)">
      <h2 style="margin:0 0 8px 0">Welcome</h2>
      <p class="wa-dim" style="margin:0 0 14px 0">
        Verify your email, get an <strong>Account ID</strong>, generate a <strong>wallet</strong>, and start a session.
      </p>

      <!-- Step 1: email → request OTP -->
      <section id="step1" class="step active">
        <label class="wa-labelblock">Email
          <input id="email" placeholder="you@example.com" type="email" autocomplete="email" />
        </label>
        <div class="wa-row">
          <button class="wa-btn" id="btnSend">Send code</button>
        </div>
        <div class="hint">We’ll email a 6-digit code to verify this address.</div>
      </section>

      <!-- Step 2: enter OTP → verify → mint Tier-1 → create account id -->
      <section id="step2" class="step">
        <div class="wa-row" style="align-items:flex-end">
          <label class="wa-labelblock" style="flex:1">Enter code
            <input id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="123456" class="mono" />
          </label>
          <button class="wa-btn wa-ghost" id="btnResend" title="Resend code">Resend</button>
        </div>
        <div class="wa-row" style="margin-top:8px">
          <button class="wa-btn" id="btnVerify">Verify & Continue</button>
        </div>
        <pre id="msg2" class="wa-pre" style="display:none;margin-top:10px"></pre>
      </section>

      <!-- Step 3: confirm/adjust Account ID (server reserves) -->
      <section id="step3" class="step">
        <label class="wa-labelblock">Your Account ID
          <input id="acct" placeholder="@you" />
        </label>
        <div class="wa-row">
          <button class="wa-btn" id="btnReserve">Reserve ID</button>
        </div>
        <div class="hint">This ID identifies you on the network. It must be unique.</div>
        <pre id="msg3" class="wa-pre" style="display:none;margin-top:10px"></pre>
      </section>

      <!-- Step 4: generate wallet → download keystore → register pubkey -->
      <section id="step4" class="step">
        <label class="wa-labelblock">Create a keystore passphrase
          <input id="pass1" type="password" placeholder="passphrase" />
        </label>
        <label class="wa-labelblock">Confirm passphrase
          <input id="pass2" type="password" placeholder="repeat passphrase" />
        </label>
        <div class="wa-row" style="margin-top:8px">
          <button class="wa-btn" id="btnMakeWallet">Generate & Download Keystore</button>
        </div>
        <div class="hint">We encrypt your private key on-device and download a keystore file. Keep it safe.</div>
        <pre id="msg4" class="wa-pre" style="display:none;margin-top:10px"></pre>
      </section>

      <!-- Step 5: start session -->
      <section id="step5" class="step">
        <div class="wa-row">
          <button class="wa-btn" id="btnStart">Start session</button>
        </div>
        <div class="hint">We’ll create a short-lived session token for your account.</div>
        <pre id="msg5" class="wa-pre" style="display:none;margin-top:10px"></pre>
      </section>

      <p class="wa-dim" style="font-size:12px;margin-top:12px">
        Private keys never leave your device. Only your public key is registered with this node.
      </p>
    </div>
  </main>

  <script>
    // If already logged in and still valid, bounce to next
    (async ()=>{
      const sess = Session.get();
      const sp = new URLSearchParams(location.search);
      const next = sp.get('next') || '/';
      if (sess && sess.expires > Date.now()/1000) { location.replace(next); return; }
    })();

    const $ = s => document.querySelector(s);
    const show = (el, on=true)=>{ el.style.display = on ? 'block':'none'; el.classList.toggle('active',on); };

    const step1 = $('#step1'), step2 = $('#step2'), step3 = $('#step3'), step4 = $('#step4'), step5 = $('#step5');
    const emailEl = $('#email'), acctEl = $('#acct'), codeEl = $('#code');
    const pass1 = $('#pass1'), pass2 = $('#pass2');
    const msg2 = $('#msg2'), msg3 = $('#msg3'), msg4 = $('#msg4'), msg5 = $('#msg5');

    let challengeId = null;
    let pending = { email:'', account_id:'', pub_b64:'' };

    function setMsg(el, t){ el.textContent=t; el.style.display='block'; }
    function clearMsg(el){ el.textContent=''; el.style.display='none'; }

    async function post(url, body) {
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
      const j = await r.json().catch(()=>({error:'bad json'}));
      if (!r.ok || j.error) throw new Error(j.error || r.status+' '+r.statusText);
      return j;
    }

    function accountFromEmail(email) {
      const local = email.split('@')[0].replace(/[^a-zA-Z0-9._-]/g,'').slice(0,20);
      return '@' + (local || 'user') + '-' + Math.random().toString(36).slice(2,6);
    }

    // Step 1: send code
    $('#btnSend').onclick = async ()=>{
      const email = emailEl.value.trim();
      if (!email) return alert('Enter email');
      try {
        const j = await post('/auth/email/request_code', { email });
        challengeId = j.challenge_id; pending.email = email;
        show(step1,false); show(step2,true);
        setMsg(msg2, `Code sent to ${email}. Expires soon.`);
      } catch (e) { alert('Failed to send code: '+e.message); }
    };

    // Step 2: verify
    $('#btnResend').onclick = async ()=>{
      if (!pending.email) return;
      try {
        const j = await post('/auth/email/request_code', { email: pending.email });
        challengeId = j.challenge_id;
        setMsg(msg2, `New code sent to ${pending.email}.`);
      } catch (e) { setMsg(msg2, 'Failed to resend: '+e.message); }
    };
    $('#btnVerify').onclick = async ()=>{
      const code = codeEl.value.trim();
      if (!code || !challengeId) return alert('Enter the 6-digit code');
      clearMsg(msg2);
      try {
        await post('/auth/email/verify', { challenge_id: challengeId, code });

        // OPTIONAL: mint Tier-1 here if your backend supports it
        try { await post('/poh/t1/mint', { email: pending.email, challenge_id: challengeId }); } catch {}

        // Ask server to create/reserve an account id for this email
        const prefer = accountFromEmail(pending.email);
        const res = await post('/accounts/create_from_email', { email: pending.email, prefer });
        pending.account_id = res.account_id;
        acctEl.value = pending.account_id;

        show(step2,false); show(step3,true);
        setMsg(msg3, `Reserved: ${pending.account_id}`);
      } catch (e) {
        setMsg(msg2, 'Verification failed: '+e.message);
      }
    };

    // Step 3: reserve/confirm id (optional re-reserve if user edits)
    $('#btnReserve').onclick = async ()=>{
      const desired = acctEl.value.trim();
      if (!desired) return alert('Enter an account id');
      try {
        const res = await post('/accounts/create_from_email', { email: pending.email, prefer: desired });
        pending.account_id = res.account_id; acctEl.value = res.account_id;
        setMsg(msg3, `Reserved: ${pending.account_id}`);
        show(step3,false); show(step4,true);
      } catch (e) {
        setMsg(msg3, 'Could not reserve: '+e.message);
      }
    };

    // Step 4: make wallet → download keystore → register public key
    $('#btnMakeWallet').onclick = async ()=>{
      if (pass1.value !== pass2.value) return setMsg(msg4, 'Passphrases do not match.');
      if (!pass1.value) return setMsg(msg4, 'Enter a passphrase.');
      clearMsg(msg4);
      try {
        const kp = await Wallet.createEd25519();
        const pubB64 = await Wallet.exportPublicRawB64(kp.publicKey);
        const pkcs8  = await Wallet.exportPrivatePkcs8(kp.privateKey);
        const ks = await Wallet.makeKeystore(pkcs8, pubB64, pass1.value);

        // Register only the public key with the node
        await post('/api/v1/auth/register_key', { account_id: pending.account_id, pubkey: pubB64 });

        // Download keystore file
        Wallet.downloadKeystore(ks, `weall_keystore_${pending.account_id.replace(/^@/,'')}.json`);

        pending.pub_b64 = pubB64;

        setMsg(msg4, 'Wallet created ✓  Keystore downloaded ✓  Public key registered ✓');
        show(step4,false); show(step5,true);
      } catch (e) {
        setMsg(msg4, 'Wallet generation failed: '+e.message);
      }
    };

    // Step 5: start session
    $('#btnStart').onclick = async ()=>{
      clearMsg(msg5);
      try {
        await Session.login(pending.account_id);
        const next = new URLSearchParams(location.search).get('next') || '/';
        location.replace(next);
      } catch (e) {
        setMsg(msg5, 'Session start failed: '+e.message);
      }
    };
  </script>
</body>
</html>
