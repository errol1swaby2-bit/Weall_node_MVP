<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WeAll • Video Capture (Tier-2 evidence)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#0b0d10; --card:#0f1319; --line:#16202b; --ink:#e8eef7; --mut:#a8b3c2; --btn:#1f2937; --btnh:#374151; --ok:#49d49d; --warn:#f6c56c; --err:#ff7f7f; }
  html,body { height:100% } body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#0e1218}
  h2{margin:0;font-size:18px}
  main{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:var(--mut);margin:8px 0 4px}
  input,select,button{width:100%;background:#0c1117;color:var(--ink);border:1px solid #223243;border-radius:8px;padding:8px 10px}
  button{cursor:pointer;background:var(--btn);border-color:#2b3a4a} button:hover{background:var(--btnh)}
  .row{display:flex;gap:8px;align-items:center} .row>*{flex:1}
  video{width:100%;background:#06080b;border-radius:10px;border:1px solid #223243}
  .pill{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #243242;background:#0c1117;margin:2px 6px 2px 0}
  .mut{color:var(--mut)} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .kvs{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0c10;border:1px solid #223243;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<script src="./auth.js"></script>
<script> weallAuth.require({ minTier: 0 }); </script>

<header>
  <h2>WeAll • Video Capture ( produce WebM clips for Tier-2 evidence )</h2>
</header>

<main>
  <section class="card">
    <h3>Camera &amp; Mic</h3>
    <div class="row">
      <select id="videoIn"></select>
      <select id="audioIn"></select>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="btnStart">Start Preview</button>
      <button id="btnStop">Stop</button>
    </div>
    <div style="margin-top:8px"><span id="badge" class="pill">idle</span></div>

    <h3 style="margin-top:12px">Recorder</h3>
    <div class="row">
      <button id="btnRec">● Record</button>
      <button id="btnPause">Pause</button>
      <button id="btnResume">Resume</button>
      <button id="btnDone">Stop & Save</button>
    </div>
    <div class="row" style="margin-top:6px">
      <input id="fileName" placeholder="filename.webm" />
      <button id="btnDownload">Download</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnOpenT2">Open Tier-2 Page</button>
      <button id="btnReset">Reset</button>
    </div>

    <div id="info" class="kvs" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h3>Preview</h3>
    <video id="preview" autoplay playsinline muted></video>

    <h3 style="margin-top:12px">Last Recording</h3>
    <video id="playback" controls playsinline></video>
  </section>
</main>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const badge = $('#badge'), info = $('#info');
  const preview = $('#preview'), playback = $('#playback');

  let stream = null, rec = null, chunks = [], blob = null, objUrl = null, sha256hex = null;

  function setBadge(txt, cls=''){ badge.className='pill '+(cls||''); badge.textContent=txt; }
  function J(x){ return JSON.stringify(x,null,2); }

  async function listDevices(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    const vids = devs.filter(d=>d.kind==='videoinput');
    const auds = devs.filter(d=>d.kind==='audioinput');
    const vSel = $('#videoIn'), aSel = $('#audioIn');
    vSel.innerHTML = vids.map(d=>`<option value="${d.deviceId}">${d.label||'Camera'}</option>`).join('');
    aSel.innerHTML = auds.map(d=>`<option value="${d.deviceId}">${d.label||'Mic'}</option>`).join('');
  }

  async function start(){
    if (stream) stop();
    const v = $('#videoIn').value || undefined;
    const a = $('#audioIn').value || undefined;
    stream = await navigator.mediaDevices.getUserMedia({
      video: v? { deviceId: { exact: v } } : true,
      audio: a? { deviceId: { exact: a } } : true
    });
    preview.srcObject = stream;
    setBadge('previewing','ok');
  }
  function stop(){
    if (!stream) return;
    stream.getTracks().forEach(t=>t.stop());
    preview.srcObject = null;
    stream = null;
    setBadge('idle');
  }

  function resetRecording(){
    if (rec) try{ rec.stop(); }catch{}
    rec=null; chunks=[]; blob=null; sha256hex=null;
    if (objUrl){ URL.revokeObjectURL(objUrl); objUrl=null; }
    playback.srcObject=null; playback.removeAttribute('src'); playback.load();
    $('#fileName').value = 'weall_evidence_'+Date.now()+'.webm';
  }

  function startRec(){
    if (!stream) return alert('Start preview first');
    resetRecording();
    const opts = { mimeType: 'video/webm;codecs=vp9,opus' };
    try { rec = new MediaRecorder(stream, opts); }
    catch { rec = new MediaRecorder(stream); }
    rec.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
    rec.onstart = ()=> setBadge('recording','warn');
    rec.onstop = async () => {
      blob = new Blob(chunks, { type: 'video/webm' });
      objUrl = URL.createObjectURL(blob);
      playback.src = objUrl;
      setBadge('recorded','ok');
      // compute SHA-256 for reference
      sha256hex = await hashBlob(blob);
      info.textContent = J({ bytes: blob.size, type: blob.type, sha256: sha256hex, object_url: objUrl });
    };
    rec.start(1000);
  }
  function pauseRec(){ if (rec && rec.state==='recording') { rec.pause(); setBadge('paused','warn'); } }
  function resumeRec(){ if (rec && rec.state==='paused') { rec.resume(); setBadge('recording','warn'); } }
  function stopRec(){ if (rec && (rec.state==='recording'||rec.state==='paused')) rec.stop(); }

  function download(){
    if (!blob) return alert('Nothing recorded yet');
    const name = ($('#fileName').value||'').trim() || ('weall_'+Date.now()+'.webm');
    const a = document.createElement('a');
    a.href = objUrl; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
  }

  async function hashBlob(b){
    const buf = await b.arrayBuffer();
    const h = await crypto.subtle.digest('SHA-256', buf);
    return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }

  // Bindings
  $('#btnStart').onclick = ()=>start().catch(e=>alert(e.message));
  $('#btnStop').onclick  = ()=>stop();
  $('#btnRec').onclick   = ()=>startRec();
  $('#btnPause').onclick = ()=>pauseRec();
  $('#btnResume').onclick= ()=>resumeRec();
  $('#btnDone').onclick  = ()=>stopRec();
  $('#btnDownload').onclick = ()=>download();
  $('#btnReset').onclick = ()=>{ resetRecording(); setBadge('previewing'); };
  $('#btnOpenT2').onclick = ()=>{ window.location.href = './onboarding.html'; };

  // Boot
  (async function init(){
    try { await navigator.mediaDevices.getUserMedia({video:true,audio:true}); } catch {}
    await listDevices();
    $('#fileName').value = 'weall_evidence_'+Date.now()+'.webm';
  })();
})();
</script>
</body>
</html>
