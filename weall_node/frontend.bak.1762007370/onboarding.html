<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Onboarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="/session.js"></script>
  <script>Session.ensure(true);</script>
</head>
<body>
  <header class="wa-topbar">
    <div class="wa-left">
      <a class="wa-link" href="/">← Back</a>
      <h1 class="wa-brand">Onboarding</h1>
    </div>
    <div class="wa-right">
      <button class="wa-iconbtn" onclick="Session.logout()" title="Logout" aria-label="Logout">
        <svg viewBox="0 0 24 24"><path d="M16 17l5-5-5-5M21 12H9M13 21H6a2 2 0 01-2-2V5a2 2 0 012-2h7"/></svg>
      </button>
    </div>
  </header>

  <main style="padding-top:60px;max-width:900px;margin:0 auto;padding:60px 16px 24px 16px">
    <div class="wa-card">
      <label class="wa-labelblock">Account ID
        <input id="acct" placeholder="@you" />
      </label>
      <div class="wa-row">
        <select id="tier">
          <option value="2">Tier 2</option>
          <option value="3" selected>Tier 3</option>
        </select>
        <button class="wa-btn" id="btnStart">Start</button>
        <button class="wa-btn wa-ghost" id="btnStatus">Status</button>
      </div>
      <pre id="out" class="wa-pre"></pre>
    </div>

    <div class="wa-card">
      <h3>Evidence</h3>
      <label class="wa-labelblock">IPFS CIDs (comma separated)
        <input id="cids" placeholder="bafy..., bafy..." />
      </label>
      <button class="wa-btn" id="btnEvidence">Submit evidence</button>
    </div>

    <div class="wa-card">
      <h3>Liveness</h3>
      <div class="wa-row">
        <input id="livScore" type="number" step="0.01" placeholder="score e.g. 0.92" />
        <label class="wa-row" style="gap:6px"><input type="checkbox" id="livPassed" /> passed</label>
        <button class="wa-btn" id="btnLiveness">Record</button>
      </div>
    </div>

    <div class="wa-card">
      <h3>Panel</h3>
      <div class="wa-row">
        <input id="reqJurors" type="number" value="10" /> required jurors
        <button class="wa-btn" id="btnSchedule">Schedule</button>
      </div>
      <div class="wa-row">
        <input id="jurorId" placeholder="@juror123" />
        <label class="wa-row" style="gap:6px"><input type="checkbox" id="jurApprove" /> approve</label>
        <button class="wa-btn" id="btnJurVote">Cast vote</button>
      </div>
      <div class="wa-row">
        <button class="wa-btn" id="btnFinalize">Finalize (issue NFT)</button>
      </div>
    </div>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const out = $('#out');

    async function post(url, body) {
      const r = await Session.authFetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
      const j = await r.json().catch(()=>({error:'bad json'}));
      return j;
    }
    async function get(url){ const r=await Session.authFetch(url); return r.json(); }

    $('#btnStart').onclick = async ()=>{
      out.textContent='Starting…';
      const j = await post('/weall/onboarding/start', {account_id: $('#acct').value.trim(), tier: Number($('#tier').value)});
      out.textContent = JSON.stringify(j,null,2);
    };
    $('#btnStatus').onclick = async ()=>{
      out.textContent='Checking…';
      const j = await get('/poh/status?account_id='+encodeURIComponent($('#acct').value.trim()));
      out.textContent = JSON.stringify(j,null,2);
    };
    $('#btnEvidence').onclick = async ()=>{
      const cids = $('#cids').value.split(',').map(s=>s.trim()).filter(Boolean);
      const j = await post('/weall/onboarding/evidence', {account_id: $('#acct').value.trim(), cids});
      out.textContent = JSON.stringify(j,null,2);
    };
    $('#btnLiveness').onclick = async ()=>{
      const j = await post('/weall/onboarding/liveness', {
        account_id: $('#acct').value.trim(),
        score: Number($('#livScore').value||0),
        passed: $('#livPassed').checked
      });
      out.textContent = JSON.stringify(j,null,2);
    };
    $('#btnSchedule').onclick = async ()=>{
      const j = await post('/weall/onboarding/panel/schedule', {
        account_id: $('#acct').value.trim(),
        required: Number($('#reqJurors').value||10)
      });
      out.textContent = JSON.stringify(j,null,2);
    };
    $('#btnJurVote').onclick = async ()=>{
      const j = await post('/weall/onboarding/panel/vote', {
        account_id: $('#acct').value.trim(),
        juror_id: $('#jurorId').value.trim(),
        approve: $('#jurApprove').checked
      });
      out.textContent = JSON.stringify(j,null,2);
    };
    $('#btnFinalize').onclick = async ()=>{
      const j = await post('/weall/onboarding/finalize', {account_id: $('#acct').value.trim(), tier: 3});
      out.textContent = JSON.stringify(j,null,2);
    };
  </script>
</body>
</html>
