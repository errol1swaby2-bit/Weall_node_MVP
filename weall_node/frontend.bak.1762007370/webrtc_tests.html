<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WeAll • WebRTC Connectivity Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0b0d10; --card:#0f1319; --line:#16202b; --ink:#e8eef7; --mut:#a8b3c2; --ok:#49d49d; --warn:#f6c56c; --err:#ff7f7f; }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;background:#0e1218;border-bottom:1px solid var(--line)}
  h2{margin:0;font-size:18px}
  main{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:var(--mut);margin:8px 0 4px}
  input,button{width:100%;background:#0c1117;color:var(--ink);border:1px solid #223243;border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  .pill{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #243242;background:#0c1117;margin:2px 6px 2px 0}
  .kvs{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0c10;border:1px solid #223243;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;word-break:break-word}
  .row{display:flex;gap:8px;align-items:center} .row>*{flex:1}
</style>
</head>
<body>
<script src="./auth.js"></script>
<script> weallAuth.require({ minTier: 0 }); </script>

<header><h2>WeAll • WebRTC Connectivity Test (STUN/TURN + loopback)</h2></header>
<main>
  <section class="card">
    <h3>ICE Config</h3>
    <div class="row">
      <button id="btnLoad">Load /webrtc/config</button>
      <button id="btnRun">Run Test</button>
    </div>
    <div id="cfg" class="kvs" style="margin-top:8px"></div>
    <div style="margin-top:8px">
      <span id="badge" class="pill">idle</span>
      <span class="pill" id="relay">relay: ?</span>
      <span class="pill" id="srflx">srflx: ?</span>
      <span class="pill" id="host">host: ?</span>
    </div>
  </section>

  <section class="card">
    <h3>Results</h3>
    <div id="out" class="kvs"></div>
  </section>
</main>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const J = x => JSON.stringify(x,null,2);
  let iceServers = null;

  function setBadge(txt, cls){ const b=$('#badge'); b.textContent=txt; b.className='pill '+(cls||''); }
  function setTypeBadge(id, ok){ const el=$(id); el.textContent = el.textContent.split(':')[0]+': '+(ok?'yes':'no'); }

  async function getJSON(p){ const r=await fetch(p); const t=await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{ j={raw:t} } if(!r.ok) throw new Error(j.error||r.status); return j; }

  $('#btnLoad').onclick = async () => {
    try{
      const r = await getJSON('/webrtc/config');
      iceServers = r.iceServers && r.iceServers.length ? r.iceServers : [{ urls:['stun:stun.l.google.com:19302'] }];
      $('#cfg').textContent = J({ iceServers });
    }catch(e){
      iceServers = [{ urls:['stun:stun.l.google.com:19302'] }];
      $('#cfg').textContent = 'Fallback ICE: ' + J(iceServers);
    }
  };

  $('#btnRun').onclick = async () => {
    if (!iceServers) await $('#btnLoad').onclick();
    setBadge('running','warn'); $('#out').textContent='';

    const types = { host:false, srflx:false, relay:false };
    const events = [];

    function pc(cfg){ return new RTCPeerConnection({ iceServers: cfg }); }
    const a = pc(iceServers), b = pc(iceServers);
    a.onicecandidate = e => { if(e.candidate){ types[e.candidate.type]=true; setTypeBadge('#'+e.candidate.type, true); b.addIceCandidate(e.candidate).catch(()=>{}); } };
    b.onicecandidate = e => { if(e.candidate){ types[e.candidate.type]=true; setTypeBadge('#'+e.candidate.type, true); a.addIceCandidate(e.candidate).catch(()=>{}); } };
    a.oniceconnectionstatechange = () => events.push(['a', a.iceConnectionState, Date.now()]);
    b.oniceconnectionstatechange = () => events.push(['b', b.iceConnectionState, Date.now()]);
    a.onconnectionstatechange = () => events.push(['a-conn', a.connectionState, Date.now()]);
    b.onconnectionstatechange = () => events.push(['b-conn', b.connectionState, Date.now()]);

    // Data channel loopback
    const dc = a.createDataChannel('t');
    let dcOpen = false;
    dc.onopen = () => { dcOpen = true; events.push(['dc', 'open', Date.now()]); };
    dc.onclose= () => events.push(['dc', 'close', Date.now()]);

    const offer = await a.createOffer({ offerToReceiveAudio:false, offerToReceiveVideo:false });
    await a.setLocalDescription(offer);
    await b.setRemoteDescription(offer);
    const answer = await b.createAnswer();
    await b.setLocalDescription(answer);
    await a.setRemoteDescription(answer);

    // Wait up to ~6s for connection
    const t0 = Date.now();
    while(Date.now()-t0 < 6000 && !dcOpen){
      await new Promise(r=>setTimeout(r,150));
    }

    const result = {
      candidates: Object.keys(types).reduce((o,k)=> (o[k]=types[k], o),{}),
      a: { ice: a.iceConnectionState, conn: a.connectionState },
      b: { ice: b.iceConnectionState, conn: b.connectionState },
      dcOpen,
      events
    };
    $('#out').textContent = J(result);
    setBadge(dcOpen ? 'ok' : 'partial', dcOpen ? 'ok' : 'warn');

    try{ a.close(); }catch{} try{ b.close(); }catch{}
  };

  // boot
  (async () => { try{ await $('#btnLoad').onclick(); }catch{} })();
})();
</script>
</body>
</html>
