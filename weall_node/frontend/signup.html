<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeAll — Create Account</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="/frontend/style.css" />
</head>
<body>
  <div id="weall_nav"></div>

  <main class="auth-shell">
    <div class="auth-card">
      <div class="auth-head">
        <div class="auth-badge"></div>
        <div>
          <div class="auth-kicker">NEW HERE</div>
          <h1 class="auth-title">CREATE ACCOUNT</h1>
          <div class="auth-sub">Handle must be <b>3–32</b> chars: <b>a–z, 0–9, _</b></div>
        </div>
      </div>

      <form id="signupForm" class="auth-form" autocomplete="on">
        <label class="auth-label">HANDLE</label>
        <input id="handle" class="auth-input" placeholder="satnak" autocomplete="username" />

        <label class="auth-label">EMAIL</label>
        <input id="email" class="auth-input" placeholder="you@example.com" autocomplete="email" />

        <label class="auth-label">PASSWORD</label>
        <input id="password" class="auth-input" type="password" placeholder="********" autocomplete="new-password" />

        <label class="auth-label">CONFIRM PASSWORD</label>
        <input id="confirm" class="auth-input" type="password" placeholder="********" autocomplete="new-password" />

        <button class="auth-btn" type="submit">CREATE ACCOUNT</button>

        <div id="msg" class="auth-msg" style="min-height:1.2em;"></div>

        <div class="auth-links">
          <a href="/frontend/login.html">Sign in instead</a>
        </div>
      </form>
    </div>
  </main>

  <script src="/frontend/session.js"></script>
  <script src="/frontend/nav.js"></script>
  <script>
    const HANDLE_RE = /^[a-z0-9_]{3,32}$/;

    function normHandle(h) {
      h = (h || "").trim().toLowerCase();
      if (h.startsWith("@")) h = h.slice(1);
      return h;
    }

    document.getElementById("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("msg");
      msg.textContent = "";

      const handle = normHandle(document.getElementById("handle").value);
      const email = (document.getElementById("email").value || "").trim().toLowerCase();
      const password = document.getElementById("password").value;
      const confirm = document.getElementById("confirm").value;

      if (!HANDLE_RE.test(handle)) {
        msg.textContent = "Handle must be 3–32 chars: a–z, 0–9, underscore. (Not an email.)";
        msg.style.color = "#ff6b6b";
        return;
      }
      if (!email.includes("@")) {
        msg.textContent = "Please enter a valid email.";
        msg.style.color = "#ff6b6b";
        return;
      }
      if (password.length < 6) {
        msg.textContent = "Password must be at least 6 characters.";
        msg.style.color = "#ff6b6b";
        return;
      }
      if (password !== confirm) {
        msg.textContent = "Passwords do not match.";
        msg.style.color = "#ff6b6b";
        return;
      }

      try {
        await weallJsonFetch("/auth/apply", {
          method: "POST",
          body: JSON.stringify({ handle, email, password })
        });
        window.location.href = "/frontend/index.html";
      } catch (err) {
        msg.textContent = err.message || "Signup failed.";
        msg.style.color = "#ff6b6b";
      }
    });
  </script>
</body>
</html>
