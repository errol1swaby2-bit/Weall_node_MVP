<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Groups, Emissaries & Treasury</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/frontend/favicon.svg" />
  <link rel="stylesheet" href="/frontend/style.css" />
  <style>
    body {
      margin: 0;
      padding: 1.2rem 1.1rem 1.6rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #22c55e22 0, #020617 55%, #020617 100%);
      color: #e5e7eb;
    }

    .wrap { max-width: 1120px; margin: 0 auto; }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1.3rem;
    }

    .page-header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .page-header .sub {
      margin: 0.35rem 0 0;
      font-size: 0.86rem;
      color: #9ca3af;
      max-width: 560px;
    }

    .back-link {
      font-size: 0.82rem;
      color: #9ca3af;
      text-decoration: none;
    }
    .back-link:hover { text-decoration: underline; }

    .signed-in-banner {
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
      text-align: right;
      max-width: 420px;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.6fr);
      gap: 1.1rem;
    }

    @media (max-width: 960px) {
      main { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.14), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.18), transparent 50%),
        rgba(15,23,42,0.96);
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 1rem 1.05rem 1.2rem;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.92);
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 0.96rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card h3 {
      margin: 0.7rem 0 0.4rem;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card p { margin: 0.15rem 0; font-size: 0.86rem; color: #cbd5f5; }

    label {
      display: block;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin: 0.6rem 0 0.15rem;
    }

    input, textarea, select {
      width: 100%;
      border-radius: 0.6rem;
      border: 1px solid rgba(30,41,59,0.9);
      padding: 0.45rem 0.6rem;
      background: rgba(15,23,42,0.98);
      color: #e5e7eb;
      font-size: 0.9rem;
      outline: none;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
    }
    textarea { min-height: 78px; resize: vertical; }

    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .row > * { flex: 1; min-width: 0; }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.85);
      padding: 0.42rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .btn.primary {
      border-color: rgba(34,197,94,0.9);
      background: radial-gradient(circle at top left,
                  rgba(34,197,94,0.5), rgba(15,23,42,0.98));
      color: #ecfeff;
    }
    .btn.small { padding: 0.3rem 0.7rem; font-size: 0.76rem; }
    .btn:disabled { opacity: 0.5; cursor: default; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.72rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.85);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #e5e7eb;
    }
    .pill .dot {
      width: 0.38rem;
      height: 0.38rem;
      border-radius: 999px;
      background: #22c55e;
    }
    .pill.muted { border-color: rgba(75,85,99,0.9); color: #9ca3af; }

    .section {
      margin-top: 0.9rem;
      padding-top: 0.5rem;
      border-top: 1px dashed rgba(31,41,55,0.9);
    }

    .groups-list {
      margin-top: 0.4rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.55rem;
    }
    .group-card {
      border-radius: 0.75rem;
      border: 1px solid rgba(31,41,55,0.95);
      background: rgba(15,23,42,0.98);
      padding: 0.55rem 0.65rem 0.65rem;
      font-size: 0.84rem;
    }
    .group-card-title {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.2rem;
      font-weight: 600;
      color: #e5e7eb;
    }
    .group-card-id {
      font-size: 0.72rem;
      color: #9ca3af;
      max-width: 8rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .group-card-desc { font-size: 0.8rem; color: #cbd5f5; margin-bottom: 0.2rem; }

    .tag-row { margin: 0.1rem 0 0.25rem; }
    .tag {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid rgba(51,65,85,0.9);
      padding: 0.06rem 0.45rem;
      font-size: 0.72rem;
      color: #9ca3af;
      margin: 0 0.25rem 0.18rem 0;
    }

    .group-card-meta { font-size: 0.76rem; color: #9ca3af; margin-bottom: 0.2rem; }

    .json-box {
      margin-top: 0.5rem;
      border-radius: 0.65rem;
      border: 1px solid rgba(15,23,42,0.9);
      background: rgba(15,23,42,0.98);
      padding: 0.45rem 0.6rem;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 0.78rem;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 260px;
      overflow: auto;
      color: #e5e7eb;
    }

    .status {
      margin-top: 0.4rem;
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #fb7185; }

    details {
      margin-top: 0.6rem;
      border-radius: 0.65rem;
      border: 1px solid rgba(31,41,55,0.95);
      background: rgba(15,23,42,0.96);
      padding: 0.45rem 0.6rem 0.6rem;
    }
    details > summary {
      cursor: pointer;
      list-style: none;
      font-size: 0.83rem;
      font-weight: 500;
      color: #e5e7eb;
    }
    details > summary::-webkit-details-marker { display: none; }
    details[open] { border-color: rgba(56,189,248,0.75); }

    footer.weall-footer {
      border-top: 1px solid rgba(31,41,55,0.9);
      padding: 0.75rem 0.1rem 1.1rem;
      margin-top: 1.6rem;
      font-size: 0.78rem;
      color: #6b7280;
      text-align: center;
    }
    footer.weall-footer a { color: #9ca3af; text-decoration: none; }
    footer.weall-footer a:hover { text-decoration: underline; }

    .note {
      margin-top: 0.4rem;
      font-size: 0.82rem;
      color: #9ca3af;
      line-height: 1.35;
    }
    .warn {
      color: #fbbf24;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="page-header">
      <a href="/frontend/index.html" class="back-link">&larr; Back to Feed</a>
      <div>
        <h1>Groups &amp; Emissaries</h1>
        <p class="sub">
          Create groups, join/leave, run emissary elections, set multisig, submit proposals,
          and manage group-scoped treasury spends (multisig).
        </p>
      </div>
      <p id="signedIn" class="signed-in-banner">Checking session…</p>
    </header>

    <main>
      <!-- LEFT -->
      <section class="card">
        <h2>Identity &amp; groups</h2>
        <p>
          This page uses your signed-in session for any endpoint that requires
          <code>X-WeAll-User</code>. You can still “act as” a different account id
          for legacy membership actions (join/leave) when testing locally.
        </p>

        <div class="section">
          <h3>Your identity</h3>

          <label for="acct">Acting Account ID (for legacy join/leave/create)</label>
          <input id="acct" placeholder="@handle or account id" />

          <div class="row" style="margin-top:0.5rem">
            <button id="btnPoh" class="btn small">Check PoH</button>
            <span class="pill muted" id="tierBadge">
              <span class="dot"></span>
              <span>tier: ?</span>
            </span>
          </div>

          <div class="note" id="actingWarn"></div>

          <div id="pohBox" class="json-box" style="margin-top:0.45rem">
            PoH status will appear here.
          </div>
        </div>

        <div class="section">
          <h3>Create group</h3>
          <label for="gName">Name</label>
          <input id="gName" placeholder="e.g., Commons Builders" />

          <label for="gDesc">Description</label>
          <textarea id="gDesc" placeholder="What is this group about?"></textarea>

          <label for="gTags">Tags (comma-separated)</label>
          <input id="gTags" placeholder="commons, dev, arts" />

          <label for="gVis">Visibility</label>
          <select id="gVis">
            <option value="public">public</option>
            <option value="private">private</option>
          </select>

          <div class="row" style="margin-top:0.6rem">
            <button id="btnCreate" class="btn primary">Create group</button>
          </div>
        </div>

        <div class="section">
          <h3>All groups</h3>
          <div class="row" style="margin-bottom:0.4rem">
            <button id="btnList" class="btn small">Refresh</button>
          </div>
          <div id="myGroups" class="groups-list"></div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <h2>Selected group</h2>
        <p>
          All group-level panels below operate on the current <strong>Group ID</strong>.
        </p>

        <div class="row" style="margin-top:0.4rem">
          <input id="selGroupId" placeholder="group_id…" />
          <button id="btnLoad" class="btn small">Load</button>
          <button id="btnJoin" class="btn small">Join</button>
          <button id="btnLeave" class="btn small">Leave</button>
        </div>

        <div id="groupBox" class="json-box" style="margin-top:0.45rem">
          Group metadata will appear here when loaded.
        </div>

        <!-- Emissaries -->
        <details class="section" open>
          <summary>Emissaries (STV-style ranked ballots)</summary>
          <p class="note">
            Backend endpoints:
            <code>/groups/emissaries/status</code>,
            <code>/groups/emissaries/nominate</code>,
            <code>/groups/emissaries/ballot</code>.
          </p>

          <div class="row" style="margin-top:0.35rem">
            <input id="emNominee" placeholder="candidate_account_id" />
            <button id="btnNominate" class="btn small">Nominate</button>
          </div>

          <div class="row" style="margin-top:0.35rem">
            <input id="emBallot" placeholder="ranked list: acct1,acct2,acct3…" />
            <button id="btnBallot" class="btn small">Submit ballot</button>
            <button id="btnEmStatus" class="btn small">Refresh status</button>
          </div>

          <div id="emBox" class="json-box" style="margin-top:0.45rem">
            Emissary election status will appear here.
          </div>
        </details>

        <!-- Multisig -->
        <details class="section">
          <summary>Group multisig</summary>
          <p class="note">
            This action requires <code>X-WeAll-User</code> and is enforced by backend:
            only emissaries can set multisig (or the creator before emissaries exist).
            Endpoint: <code>/groups/multisig/set</code>
          </p>

          <label for="msSigners">Signers (comma-separated)</label>
          <input id="msSigners" placeholder="@acct1,@acct2,@acct3…" />

          <label for="msThresh">Threshold</label>
          <input id="msThresh" placeholder="e.g. 3" />

          <div class="row" style="margin-top:0.4rem">
            <button id="btnMultisigSet" class="btn small">Set multisig</button>
          </div>

          <div id="msBox" class="json-box" style="margin-top:0.4rem">
            Multisig config will appear here.
          </div>
        </details>

        <!-- Polls removed -->
        <details class="section">
          <summary>Polls</summary>
          <p class="note">
            <span class="warn">Disabled:</span> this snapshot does not expose any <code>/polls/*</code> backend routes yet.
            If you want, we can later implement a polls API or map “polls” to lightweight proposals.
          </p>
        </details>

        <!-- Proposals -->
        <details class="section" open>
          <summary>Proposals (Governance)</summary>
          <p class="note">
            Wired to: <code>GET /proposals</code>, <code>POST /proposals</code>,
            <code>POST /proposals/{id}/vote</code>, <code>POST /proposals/{id}/close</code>.
            Group scoping uses <code>group_id</code> in the proposal object.
          </p>

          <label for="prTitle">Title</label>
          <input id="prTitle" placeholder="e.g., Fund community tooling" />

          <label for="prDesc">Description</label>
          <textarea id="prDesc" placeholder="Short description"></textarea>

          <div class="row" style="margin-top:0.35rem">
            <div>
              <label for="prType">Type</label>
              <input id="prType" placeholder="signal" value="signal" />
            </div>
            <div>
              <label for="prAudience">Audience</label>
              <select id="prAudience">
                <option value="global">global</option>
                <option value="group_members">group_members</option>
                <option value="group_emissaries">group_emissaries</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:0.35rem">
            <div>
              <label for="prDuration">Duration (seconds)</label>
              <input id="prDuration" placeholder="604800" value="604800" />
            </div>
            <div>
              <label for="prOptions">Options (comma-separated; empty = default yes/no/abstain)</label>
              <input id="prOptions" placeholder="yes,no,abstain" />
            </div>
          </div>

          <div class="row" style="margin-top:0.4rem">
            <button id="btnPropCreate" class="btn small">Create proposal</button>
            <button id="btnPropList" class="btn small">List proposals</button>
          </div>

          <div class="row" style="margin-top:0.35rem">
            <input id="prVoteId" placeholder="proposal_id" />
            <select id="prVoteChoice">
              <option>yes</option>
              <option>no</option>
              <option>abstain</option>
            </select>
            <button id="btnPropVote" class="btn small">Vote</button>
            <button id="btnPropClose" class="btn small">Close</button>
          </div>

          <div id="propBox" class="json-box" style="margin-top:0.4rem">
            Proposals and tallies will appear here.
          </div>
        </details>

        <!-- Treasury -->
        <details class="section" open>
          <summary>Treasury (node pools + group spend multisig)</summary>
          <p class="note">
            Node treasury:
            <code>GET /treasury/meta</code> + <code>GET /treasury/pools</code>.
            <br />
            Group spend workflow (multisig):
            <code>POST /treasury/group_spend/propose</code>,
            <code>GET /treasury/group_spend/list?group_id=...</code>,
            <code>POST /treasury/group_spend/sign</code>,
            <code>POST /treasury/group_spend/execute</code>.
          </p>

          <div class="row" style="margin-top:0.35rem">
            <button id="btnTreasuryMeta" class="btn small">Treasury meta</button>
            <button id="btnTreasuryPools" class="btn small">Treasury pools</button>
            <button id="btnSpendList" class="btn small">List spends (group)</button>
          </div>

          <h3 style="margin-top:0.8rem;">Propose spend (group multisig)</h3>

          <label for="spTo">To account</label>
          <input id="spTo" placeholder="@recipient" />

          <div class="row" style="margin-top:0.35rem">
            <div>
              <label for="spAmt">Amount</label>
              <input id="spAmt" placeholder="10.0" />
            </div>
            <div>
              <label for="spMemo">Memo</label>
              <input id="spMemo" placeholder="optional memo" />
            </div>
          </div>

          <div class="row" style="margin-top:0.4rem">
            <button id="btnSpendPropose" class="btn small">Propose</button>
          </div>

          <h3 style="margin-top:0.8rem;">Sign / execute spend</h3>
          <div class="row" style="margin-top:0.35rem">
            <input id="spId" placeholder="spend_id" />
            <input id="spNote" placeholder="sign note (optional)" />
            <button id="btnSpendSign" class="btn small">Sign</button>
            <button id="btnSpendExec" class="btn small">Execute</button>
          </div>

          <div id="treBox" class="json-box" style="margin-top:0.4rem">
            Treasury info will appear here.
          </div>
        </details>
      </section>
    </main>

    <footer class="weall-footer">
      <span>© <span id="footer-year">2024</span> WeAll</span>
      &nbsp;•&nbsp;<a href="/frontend/privacy.html">Privacy</a>
      &nbsp;•&nbsp;<a href="/frontend/terms.html">Terms</a>
    </footer>
  </div>

  <script src="/frontend/env.js"></script>
  <script src="/frontend/auth.js"></script>
  <script src="/frontend/session.js"></script>
  <script src="/frontend/nav.js"></script>
  <script src="/frontend/footer.js"></script>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      let CURRENT_SESSION = null;
      let LOADED_GROUP = null;

      function apiBase() {
        return (window.ENV && window.ENV.VITE_API_BASE) || "";
      }

      function J(obj) {
        try { return JSON.stringify(obj, null, 2); }
        catch { return String(obj); }
      }

      async function jsonFetch(path, opts) {
        const url = apiBase() + path;
        const options = Object.assign(
          { headers: { Accept: "application/json" }, credentials: "include" },
          opts || {}
        );

        options.headers = options.headers || {};
        if (CURRENT_SESSION && CURRENT_SESSION.user_id) {
          options.headers["X-WeAll-User"] = CURRENT_SESSION.user_id;
        }

        if (options.body && typeof options.body !== "string") {
          options.headers["Content-Type"] = options.headers["Content-Type"] || "application/json";
          options.body = JSON.stringify(options.body);
        }

        const res = await fetch(url, options);
        let data = null;
        try { data = await res.json(); } catch { data = null; }

        if (!res.ok) {
          const msg = (data && (data.detail || data.error || data.message)) || ("Request failed with " + res.status);
          throw new Error(msg);
        }
        return data;
      }

      function actingAccount() {
        return (($("acct") && $("acct").value) || "").trim();
      }

      function selectedGroupId() {
        return (($("selGroupId") && $("selGroupId").value) || "").trim();
      }

      function parseCsv(s) {
        return (s || "")
          .split(",")
          .map(x => x.trim())
          .filter(Boolean);
      }

      function requireSession() {
        if (!CURRENT_SESSION || !CURRENT_SESSION.user_id) {
          alert("You must be signed in for this action.");
          window.location.href = "/frontend/login.html";
          return false;
        }
        return true;
      }

      function updateActingWarn() {
        const warnEl = $("actingWarn");
        if (!warnEl) return;

        if (!CURRENT_SESSION || !CURRENT_SESSION.user_id) {
          warnEl.textContent = "";
          return;
        }

        const act = actingAccount();
        if (act && act !== CURRENT_SESSION.user_id) {
          warnEl.innerHTML =
            '<span class="warn">Note:</span> acting account differs from signed-in user. ' +
            'Multisig, proposals, and treasury spend actions will use the signed-in user ' +
            '(' + CURRENT_SESSION.user_id + ') via X-WeAll-User.';
        } else {
          warnEl.textContent = "";
        }
      }

      function buildRoleBanner(userId, roles, nodeMeta, poh) {
        const parts = [];

        const tier =
          (roles && (roles.poh_tier ?? roles.pohTier)) ||
          (poh && typeof poh.tier === "number" ? poh.tier : 0) || 0;
        const status = (poh && poh.status) || "ok";
        parts.push("PoH Tier " + tier + " (" + status + ")");

        const flags = (roles && roles.flags) || {};
        const caps = (roles && roles.capabilities) || [];
        const tags = [];

        if (flags.wants_creator || caps.includes("earn_creator_rewards")) tags.push("Creator");
        if (flags.wants_juror || caps.includes("serve_juror_panel")) tags.push("Juror");
        if (flags.wants_validator || caps.includes("validator_duties")) tags.push("Validator");
        if (flags.wants_operator || caps.includes("operator_duties")) tags.push("Operator");
        if (flags.wants_emissary || caps.includes("act_as_emissary")) tags.push("Emissary");
        if (tags.length) parts.push(tags.join(" · "));

        const nodeKind = (nodeMeta && nodeMeta.node_kind) || "public_gateway";
        if (nodeKind === "validator_node") parts.push("Validator node");
        else if (nodeKind === "private_node") parts.push("Private node");
        else parts.push("Gateway node");

        return "Signed in as " + userId + " · " + parts.join(" · ");
      }

      async function refreshSessionAndPoh() {
        const bannerEl = $("signedIn");
        const tierBadge = $("tierBadge");
        const pohBox = $("pohBox");
        const acctInput = $("acct");

        try {
          const sess = await weallAuth.getSession();
          CURRENT_SESSION = sess || null;

          if (!sess || !sess.user_id) {
            if (bannerEl) bannerEl.textContent = "Not signed in.";
            if (pohBox) pohBox.textContent = "Please log in to see PoH status.";
            if (tierBadge) tierBadge.querySelector("span:nth-child(2)").textContent = "tier: ?";
            updateActingWarn();
            return null;
          }

          const [poh, roles, nodeMeta] = await Promise.all([
            weallAuth.getPohMe().catch(() => null),
            jsonFetch("/roles/effective/me", { headers: { "X-WeAll-User": sess.user_id } }).catch(() => null),
            jsonFetch("/node/meta").catch(() => null),
          ]);

          if (bannerEl) bannerEl.textContent = buildRoleBanner(sess.user_id, roles, nodeMeta, poh);

          if (acctInput && !acctInput.value) acctInput.value = sess.user_id;

          const tier = (poh && typeof poh.tier === "number") ? poh.tier : ((roles && roles.poh_tier) || 0);
          if (tierBadge) {
            const labelSpan = tierBadge.querySelector("span:nth-child(2)");
            if (labelSpan) labelSpan.textContent = "tier: " + (tier || 0);
          }

          if (pohBox) pohBox.textContent = poh ? J(poh) : "No PoH record found.";
          updateActingWarn();
          return { sess, poh, roles, nodeMeta };
        } catch (err) {
          console.error("refreshSessionAndPoh error:", err);
          CURRENT_SESSION = null;
          if (bannerEl) bannerEl.textContent = "Unable to load session.";
          if (pohBox) pohBox.textContent = "Failed to load PoH status: " + err.message;
          if (tierBadge) {
            const labelSpan = tierBadge.querySelector("span:nth-child(2)");
            if (labelSpan) labelSpan.textContent = "tier: ?";
          }
          updateActingWarn();
          return null;
        }
      }

      // ---------------- Groups ----------------

      async function groupsList() {
        const box = $("myGroups");
        const acct = actingAccount();
        if (!box) return;

        box.innerHTML = "Loading groups…";

        try {
          const res = await jsonFetch("/groups/list");
          const groups = (res && res.groups) || [];
          if (!groups.length) {
            box.textContent = "No groups yet.";
            return;
          }

          box.innerHTML = "";
          for (const g of groups) {
            const card = document.createElement("article");
            card.className = "group-card";

            const members = (g.members || []);
            const isMember = acct ? members.includes(acct) : false;

            card.innerHTML = `
              <div class="group-card-title">
                <span>${g.name || "(unnamed group)"}</span>
                <span class="group-card-id">${g.id || ""}</span>
              </div>
              <div class="group-card-desc">${g.description || ""}</div>
              <div class="tag-row">
                ${(g.tags || []).map((t) => `<span class="tag">${t}</span>`).join("")}
              </div>
              <div class="group-card-meta">
                members: ${members.length} · status: ${g.status || "unknown"} · visibility: ${g.visibility || "public"}
              </div>
              <div class="row" style="margin-top:0.25rem">
                <button class="btn small btnSel" data-gid="${g.id || ""}">Select</button>
                ${isMember ? '<span class="pill"><span class="dot"></span><span>member</span></span>' : ""}
              </div>
            `;
            box.appendChild(card);
          }

          box.querySelectorAll(".btnSel").forEach((btn) => {
            btn.addEventListener("click", () => {
              const gid = btn.getAttribute("data-gid");
              if ($("selGroupId") && gid) {
                $("selGroupId").value = gid;
                loadGroup().catch((e) => alert(e.message));
              }
            });
          });
        } catch (err) {
          console.error("groupsList error:", err);
          box.textContent = "Failed to load groups: " + err.message;
        }
      }

      async function groupCreate() {
        const acct = actingAccount();
        const name = (($("gName") && $("gName").value) || "").trim();
        const desc = (($("gDesc") && $("gDesc").value) || "").trim();
        const tags = parseCsv(($("gTags") && $("gTags").value) || "");
        const vis = (($("gVis") && $("gVis").value) || "public").trim();

        if (!acct) return alert("Enter acting account id first.");
        if (!name) return alert("Name required.");

        const payload = { name, description: desc, tags, visibility: vis, created_by: acct };

        try {
          const res = await jsonFetch("/groups/create", { method: "POST", body: payload });
          const gid = res && res.group && res.group.id;

          if ($("selGroupId") && gid) $("selGroupId").value = gid;

          await groupsList();
          await loadGroup();
        } catch (err) {
          console.error("groupCreate error:", err);
          alert("Failed to create group: " + err.message);
        }
      }

      async function loadGroup() {
        const gid = selectedGroupId();
        const box = $("groupBox");
        if (!gid || !box) return;

        box.textContent = "Loading group…";
        LOADED_GROUP = null;

        try {
          const res = await jsonFetch("/groups/get", { method: "POST", body: { group_id: gid } });
          const group = res.group || res;

          LOADED_GROUP = group;
          box.textContent = J(group);

          // preload panels
          await emissaryStatus();
          multisigShow();
          await proposalsList();
          await treasuryPools();
          await spendsList();
        } catch (err) {
          console.error("loadGroup error:", err);
          box.textContent = "Failed to load group: " + err.message;
        }
      }

      async function joinGroup() {
        const acct = actingAccount();
        const gid = selectedGroupId();
        if (!acct) return alert("Enter acting account id.");
        if (!gid) return alert("Enter group id.");

        try {
          await jsonFetch("/groups/join", { method: "POST", body: { group_id: gid, account_id: acct } });
          await loadGroup();
          await groupsList();
        } catch (err) {
          console.error("joinGroup error:", err);
          alert("Failed to join group: " + err.message);
        }
      }

      async function leaveGroup() {
        const acct = actingAccount();
        const gid = selectedGroupId();
        if (!acct) return alert("Enter acting account id.");
        if (!gid) return alert("Enter group id.");

        try {
          await jsonFetch("/groups/leave", { method: "POST", body: { group_id: gid, account_id: acct } });
          await loadGroup();
          await groupsList();
        } catch (err) {
          console.error("leaveGroup error:", err);
          alert("Failed to leave group: " + err.message);
        }
      }

      // ---------------- Emissaries ----------------

      async function emissaryStatus() {
        const gid = selectedGroupId();
        const box = $("emBox");
        if (!gid || !box) return;

        box.textContent = "Loading emissary status…";
        try {
          const res = await jsonFetch("/groups/emissaries/status", { method: "POST", body: { group_id: gid } });
          box.textContent = J(res);
        } catch (err) {
          console.error("emissaryStatus error:", err);
          box.textContent = "Failed to load emissary status: " + err.message;
        }
      }

      async function emissaryNominate() {
        const gid = selectedGroupId();
        const nominator = actingAccount();
        const candidate = (($("emNominee") && $("emNominee").value) || "").trim();
        if (!gid) return alert("Select a group first.");
        if (!nominator) return alert("Enter acting account id (nominator).");
        if (!candidate) return alert("Enter candidate account id.");

        try {
          const res = await jsonFetch("/groups/emissaries/nominate", {
            method: "POST",
            body: { group_id: gid, nominator_id: nominator, candidate_id: candidate }
          });
          $("emBox").textContent = J(res);
        } catch (err) {
          console.error("emissaryNominate error:", err);
          alert("Failed to nominate: " + err.message);
        }
      }

      async function emissaryBallot() {
        const gid = selectedGroupId();
        const voter = actingAccount();
        const ranking = parseCsv(($("emBallot") && $("emBallot").value) || "");
        if (!gid) return alert("Select a group first.");
        if (!voter) return alert("Enter acting account id (voter).");
        if (!ranking.length) return alert("Enter a ranked list.");

        try {
          const res = await jsonFetch("/groups/emissaries/ballot", {
            method: "POST",
            body: { group_id: gid, voter_id: voter, ranking }
          });
          $("emBox").textContent = J(res);
        } catch (err) {
          console.error("emissaryBallot error:", err);
          alert("Failed to submit ballot: " + err.message);
        }
      }

      // ---------------- Multisig ----------------

      function multisigShow() {
        const box = $("msBox");
        if (!box) return;

        if (!LOADED_GROUP) {
          box.textContent = "Load a group first.";
          return;
        }
        box.textContent = J({ group_id: LOADED_GROUP.id, multisig: LOADED_GROUP.multisig || {} });
      }

      async function multisigSet() {
        if (!requireSession()) return;

        const gid = selectedGroupId();
        if (!gid) return alert("Select a group first.");

        const signers = parseCsv(($("msSigners") && $("msSigners").value) || "");
        const thresholdRaw = (($("msThresh") && $("msThresh").value) || "").trim();
        const threshold = parseInt(thresholdRaw || "0", 10);

        if (!signers.length) return alert("Provide at least 1 signer.");
        if (!Number.isFinite(threshold) || threshold < 0) return alert("Threshold must be >= 0.");

        try {
          const res = await jsonFetch("/groups/multisig/set", {
            method: "POST",
            body: { group_id: gid, signers, threshold }
          });
          $("msBox").textContent = J(res);

          // refresh group so UI reflects new multisig
          await loadGroup();
        } catch (err) {
          console.error("multisigSet error:", err);
          alert("Failed to set multisig: " + err.message);
        }
      }

      // ---------------- Proposals (Governance) ----------------

      async function proposalsList() {
        const gid = selectedGroupId();
        const box = $("propBox");
        if (!box) return;

        box.textContent = "Loading proposals…";

        try {
          const res = await jsonFetch("/proposals", { method: "GET" });
          const proposals = (res && res.proposals) || [];

          // If a group is selected, filter to group proposals or show all if none match
          const filtered = gid ? proposals.filter(p => (p.group_id || null) === gid) : proposals;

          const out = {
            ok: true,
            selected_group_id: gid || null,
            count: filtered.length,
            proposals: filtered
          };

          box.textContent = J(out);
        } catch (err) {
          console.error("proposalsList error:", err);
          box.textContent = "Failed to load proposals: " + err.message;
        }
      }

      async function proposalCreate() {
        if (!requireSession()) return;

        const gid = selectedGroupId() || null;

        const title = (($("prTitle") && $("prTitle").value) || "").trim();
        const description = (($("prDesc") && $("prDesc").value) || "").trim();
        const type = (($("prType") && $("prType").value) || "signal").trim();
        const audience = (($("prAudience") && $("prAudience").value) || "global").trim();
        const duration_sec = parseInt((($("prDuration") && $("prDuration").value) || "604800").trim(), 10);
        const optionsRaw = (($("prOptions") && $("prOptions").value) || "").trim();
        const options = optionsRaw ? parseCsv(optionsRaw) : null;

        if (!title) return alert("Title required.");

        const payload = {
          title,
          description,
          created_by: CURRENT_SESSION.user_id,
          type,
          options,
          duration_sec: Number.isFinite(duration_sec) ? duration_sec : 604800,
          group_id: gid,
          audience
        };

        try {
          const res = await jsonFetch("/proposals", { method: "POST", body: payload });
          $("propBox").textContent = J(res);
          await proposalsList();
        } catch (err) {
          console.error("proposalCreate error:", err);
          alert("Failed to create proposal: " + err.message);
        }
      }

      async function proposalVote() {
        if (!requireSession()) return;

        const pid = (($("prVoteId") && $("prVoteId").value) || "").trim();
        const choice = (($("prVoteChoice") && $("prVoteChoice").value) || "").trim();
        if (!pid) return alert("Enter proposal_id.");
        if (!choice) return alert("Choose a vote option.");

        try {
          const res = await jsonFetch(`/proposals/${encodeURIComponent(pid)}/vote`, {
            method: "POST",
            body: { choice }
          });
          $("propBox").textContent = J(res);
          await proposalsList();
        } catch (err) {
          console.error("proposalVote error:", err);
          alert("Failed to vote: " + err.message);
        }
      }

      async function proposalClose() {
        if (!requireSession()) return;

        const pid = (($("prVoteId") && $("prVoteId").value) || "").trim();
        if (!pid) return alert("Enter proposal_id (use the same field).");

        try {
          const res = await jsonFetch(`/proposals/${encodeURIComponent(pid)}/close`, { method: "POST" });
          $("propBox").textContent = J(res);
          await proposalsList();
        } catch (err) {
          console.error("proposalClose error:", err);
          alert("Failed to close: " + err.message);
        }
      }

      // ---------------- Treasury ----------------

      async function treasuryMeta() {
        const box = $("treBox");
        if (!box) return;
        box.textContent = "Loading treasury meta…";

        try {
          const res = await jsonFetch("/treasury/meta", { method: "GET" });
          box.textContent = J(res);
        } catch (err) {
          console.error("treasuryMeta error:", err);
          box.textContent = "Failed to load treasury meta: " + err.message;
        }
      }

      async function treasuryPools() {
        const box = $("treBox");
        if (!box) return;
        box.textContent = "Loading treasury pools…";

        try {
          const res = await jsonFetch("/treasury/pools", { method: "GET" });
          box.textContent = J(res);
        } catch (err) {
          console.error("treasuryPools error:", err);
          box.textContent = "Failed to load treasury pools: " + err.message;
        }
      }

      async function spendPropose() {
        if (!requireSession()) return;

        const gid = selectedGroupId();
        if (!gid) return alert("Select a group first.");

        const to_account = (($("spTo") && $("spTo").value) || "").trim();
        const amount = parseFloat((($("spAmt") && $("spAmt").value) || "").trim());
        const memo = (($("spMemo") && $("spMemo").value) || "").trim();

        if (!to_account) return alert("To account required.");
        if (!Number.isFinite(amount) || amount <= 0) return alert("Amount must be a positive number.");

        try {
          const res = await jsonFetch("/treasury/group_spend/propose", {
            method: "POST",
            body: { group_id: gid, to_account, amount, memo }
          });
          $("treBox").textContent = J(res);

          const spendId = res && res.spend && res.spend.id;
          if ($("spId") && spendId) $("spId").value = spendId;

          await spendsList();
        } catch (err) {
          console.error("spendPropose error:", err);
          alert("Failed to propose spend: " + err.message);
        }
      }

      async function spendsList() {
        const box = $("treBox");
        const gid = selectedGroupId();
        if (!box) return;
        if (!gid) return;

        try {
          const res = await jsonFetch(`/treasury/group_spend/list?group_id=${encodeURIComponent(gid)}`, { method: "GET" });
          box.textContent = J(res);
        } catch (err) {
          console.error("spendsList error:", err);
          box.textContent = "Failed to list spends: " + err.message;
        }
      }

      async function spendSign() {
        if (!requireSession()) return;

        const spend_id = (($("spId") && $("spId").value) || "").trim();
        const note = (($("spNote") && $("spNote").value) || "").trim();
        if (!spend_id) return alert("spend_id required.");

        try {
          const res = await jsonFetch("/treasury/group_spend/sign", {
            method: "POST",
            body: { spend_id, note }
          });
          $("treBox").textContent = J(res);
          await spendsList();
        } catch (err) {
          console.error("spendSign error:", err);
          alert("Failed to sign spend: " + err.message);
        }
      }

      async function spendExecute() {
        if (!requireSession()) return;

        const spend_id = (($("spId") && $("spId").value) || "").trim();
        if (!spend_id) return alert("spend_id required.");

        try {
          const res = await jsonFetch("/treasury/group_spend/execute", {
            method: "POST",
            body: { spend_id }
          });
          $("treBox").textContent = J(res);
          await spendsList();
        } catch (err) {
          console.error("spendExecute error:", err);
          alert("Failed to execute spend: " + err.message);
        }
      }

      // ---------------- Wire UI ----------------

      document.addEventListener("DOMContentLoaded", async () => {
        await refreshSessionAndPoh();
        await groupsList();

        const acctInput = $("acct");
        if (acctInput) {
          acctInput.addEventListener("input", () => updateActingWarn());
        }

        $("btnPoh") && $("btnPoh").addEventListener("click", refreshSessionAndPoh);

        $("btnList") && $("btnList").addEventListener("click", groupsList);
        $("btnCreate") && $("btnCreate").addEventListener("click", groupCreate);

        $("btnLoad") && $("btnLoad").addEventListener("click", loadGroup);
        $("btnJoin") && $("btnJoin").addEventListener("click", joinGroup);
        $("btnLeave") && $("btnLeave").addEventListener("click", leaveGroup);

        $("btnNominate") && $("btnNominate").addEventListener("click", emissaryNominate);
        $("btnBallot") && $("btnBallot").addEventListener("click", emissaryBallot);
        $("btnEmStatus") && $("btnEmStatus").addEventListener("click", emissaryStatus);

        $("btnMultisigSet") && $("btnMultisigSet").addEventListener("click", multisigSet);

        $("btnPropList") && $("btnPropList").addEventListener("click", proposalsList);
        $("btnPropCreate") && $("btnPropCreate").addEventListener("click", proposalCreate);
        $("btnPropVote") && $("btnPropVote").addEventListener("click", proposalVote);
        $("btnPropClose") && $("btnPropClose").addEventListener("click", proposalClose);

        $("btnTreasuryMeta") && $("btnTreasuryMeta").addEventListener("click", treasuryMeta);
        $("btnTreasuryPools") && $("btnTreasuryPools").addEventListener("click", treasuryPools);

        $("btnSpendPropose") && $("btnSpendPropose").addEventListener("click", spendPropose);
        $("btnSpendList") && $("btnSpendList").addEventListener("click", spendsList);
        $("btnSpendSign") && $("btnSpendSign").addEventListener("click", spendSign);
        $("btnSpendExec") && $("btnSpendExec").addEventListener("click", spendExecute);
      });
    })();
  </script>
</body>
</html>
