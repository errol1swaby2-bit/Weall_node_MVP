<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WeAll - User Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      padding: 1.2rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #f9fafb;
    }
    a { color: #22c55e; text-decoration: none; }
    a:hover { text-decoration: underline; }
    header { margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    header h1 { font-size: 1.6rem; margin: 0; }
    .back-link { font-size: 0.9rem; }
    .cards { display: flex; flex-direction: column; gap: 1rem; }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #1f2937;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }
    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }
    .card.poh h2,
    .card.wallet h2,
    .card.rep h2 { color: #22c55e; }
    .label { font-weight: 600; font-size: 0.9rem; }
    .value { font-size: 0.95rem; }
    .row { margin-top: 0.3rem; }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      margin-top: 0.6rem;
    }
    button:active { transform: scale(0.97); }
    input {
      width: 100%;
      padding: 0.45rem 0.6rem;
      margin-top: 0.25rem;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      box-sizing: border-box;
    }
    .muted { font-size: 0.85rem; opacity: 0.8; }
    .error { color: #f97373; font-size: 0.85rem; margin-top: 0.4rem; }
    .success { color: #4ade80; font-size: 0.85rem; margin-top: 0.4rem; }
  </style>
</head>
<body>
  <header>
    <div class="back-link"><a href="/frontend/index.html">← Back to Feed</a></div>
    <h1>User Profile</h1>
  </header>

  <div class="muted" id="userIdLine">User: loading…</div>

  <div class="cards">

    <!-- Proof of Humanity -->
    <section class="card poh">
      <h2>Proof of Humanity</h2>
      <div class="row">
        <span class="label">User ID:</span>
        <span class="value" id="pohUserId">loading…</span>
      </div>
      <div class="row">
        <span class="label">Tier:</span>
        <span class="value" id="pohTier">Loading…</span>
      </div>
      <div class="row muted" id="pohStatusMsg"></div>
      <button id="pohRefreshBtn">Refresh Status</button>
      <div class="error" id="pohError"></div>
    </section>

    <!-- Wallet -->
    <section class="card wallet">
      <h2>Wallet</h2>
      <div class="row">
        <span class="label">Address:</span>
        <span class="value" id="walletAddress">(loading…)</span>
      </div>
      <div class="row">
        <span class="label">Balance:</span>
        <span class="value" id="walletBalance">0 WEC</span>
      </div>

      <div class="row" style="margin-top:0.7rem;">
        <span class="label">Recipient User ID</span>
        <input id="sendRecipient" placeholder="@friend">
      </div>
      <div class="row">
        <span class="label">Amount (WEC)</span>
        <input id="sendAmount" placeholder="0.0" inputmode="decimal">
      </div>
      <button id="sendBtn">Send WEC</button>
      <div class="error" id="walletError"></div>
      <div class="success" id="walletSuccess"></div>
    </section>

    <!-- Reputation -->
    <section class="card rep">
      <h2>Reputation</h2>
      <div class="row">
        <span class="label">Score:</span>
        <span class="value" id="repScore">Loading…</span>
      </div>
      <button id="repRefreshBtn">Refresh</button>
      <div class="error" id="repError"></div>
    </section>

    <!-- Governance -->
    <section class="card">
      <h2>Governance</h2>
      <div class="muted">Create and vote on proposals.</div>
      <button onclick="window.location.href='/frontend/governance.html'">Open Governance</button>
    </section>

  </div>

<script>
  // -------------------------
  // User identity
  // -------------------------
  function getCurrentUserId() {
    let v = localStorage.getItem("weall.account") ||
            localStorage.getItem("weall_user") ||
            "";
    v = (v || "").trim().toLowerCase();
    if (!v) return "unknown";
    if (v.includes("@") && !v.startsWith("@")) {
      return "@" + v.split("@", 1)[0];
    }
    return v;
  }

  const userId = getCurrentUserId();
  document.getElementById("userIdLine").textContent = "User: " + userId;
  document.getElementById("pohUserId").textContent = userId;

  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts || {});
    let data = {};
    try { data = await res.json(); } catch {}
    if (!res.ok) throw new Error(data.detail || data.error || "Request failed");
    return data;
  }

  // -------------------------
  // PoH Section
  // -------------------------
  async function refreshPoh() {
    const tEl = document.getElementById("pohTier");
    const sEl = document.getElementById("pohStatusMsg");
    const eEl = document.getElementById("pohError");

    tEl.textContent = "Loading…";
    sEl.textContent = "";
    eEl.textContent = "";

    try {
      const data = await fetchJSON("/poh/status/" + encodeURIComponent(userId));
      tEl.textContent = data.tier ?? "None";
      sEl.textContent = data.status || (data.tier ? "Verified" : "Not verified");
    } catch (err) {
      eEl.textContent = "PoH error: " + err.message;
      tEl.textContent = "Unknown";
    }
  }

  document.getElementById("pohRefreshBtn").onclick = refreshPoh;

  // -------------------------
  // Wallet Section
  // -------------------------
  async function refreshWallet() {
    const balEl = document.getElementById("walletBalance");
    const addrEl = document.getElementById("walletAddress");
    const errEl = document.getElementById("walletError");

    balEl.textContent = "Loading…";
    errEl.textContent = "";

    try {
      const data = await fetchJSON("/ledger/balance/" + encodeURIComponent(userId));
      balEl.textContent = (data.balance || 0) + " WEC";
      addrEl.textContent = (data.wallet && data.wallet.address) || "(not set)";
    } catch (err) {
      errEl.textContent = "Wallet error: " + err.message;
      balEl.textContent = "0 WEC";
    }
  }

  async function sendWEC() {
    const recip = document.getElementById("sendRecipient").value.trim().toLowerCase();
    const amt = parseFloat(document.getElementById("sendAmount").value);
    const errEl = document.getElementById("walletError");
    const okEl = document.getElementById("walletSuccess");

    errEl.textContent = "";
    okEl.textContent = "";

    if (!recip) {
      errEl.textContent = "Recipient required.";
      return;
    }
    let cleanRecip = recip;
    if (recip.includes("@") && !recip.startsWith("@")) {
      cleanRecip = "@" + recip.split("@", 1)[0];
    }

    if (!amt || amt <= 0) {
      errEl.textContent = "Enter a positive amount.";
      return;
    }

    try {
      await fetchJSON("/wallet/transfer", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          sender: userId,
          recipient: cleanRecip,
          amount: amt
        })
      });
      okEl.textContent = "Transfer complete.";
      refreshWallet();
    } catch (err) {
      errEl.textContent = "Transfer failed: " + err.message;
    }
  }

  document.getElementById("sendBtn").onclick = sendWEC;

  // -------------------------
  // Reputation Section
  // -------------------------
  async function refreshRep() {
    const scoreEl = document.getElementById("repScore");
    const errEl = document.getElementById("repError");

    scoreEl.textContent = "Loading…";
    errEl.textContent = "";

    try {
      const data = await fetchJSON("/reputation/" + encodeURIComponent(userId));
      scoreEl.textContent = data.score ?? data.reputation ?? 0;
    } catch (err) {
      errEl.textContent = "Reputation error: " + err.message;
      scoreEl.textContent = "0";
    }
  }

  document.getElementById("repRefreshBtn").onclick = refreshRep;

  // -------------------------
  // Initial Load
  // -------------------------
  refreshPoh();
  refreshWallet();
  refreshRep();
</script>
</body>
</html>
