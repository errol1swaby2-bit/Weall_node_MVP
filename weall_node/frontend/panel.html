<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Node Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="icon" href="/frontend/favicon.svg" />
  <link rel="stylesheet" href="/frontend/style.css" />
  <style>
    .pn-shell { max-width: 1160px; margin: 0 auto; padding: 18px 14px 40px; }
    .pn-head { display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; margin: 10px 0 14px; }
    .pn-title { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .pn-sub { margin: 4px 0 0; color: var(--muted); font-size: 13px; max-width: 760px; }

    .pn-actions { display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
    .pn-btn {
      border: 1px solid var(--border);
      background: rgba(17,21,27,.7);
      color: var(--fg);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .pn-btn:hover { border-color: rgba(110,231,183,.6); }
    .pn-btn.primary { border-color: rgba(110,231,183,.7); }
    .pn-btn:disabled { opacity: .5; cursor: default; }

    .pn-pill {
      display:inline-flex; align-items:center; gap: 8px;
      border: 1px solid var(--border);
      background: rgba(17,21,27,.55);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-top: 8px;
    }
    .pn-dot { width: 10px; height: 10px; border-radius: 999px; background: var(--danger); flex: 0 0 auto; }
    .pn-dot.ok { background: var(--accent); }
    .pn-dot.warn { background: #fbbf24; }
    .pn-dot.fail { background: var(--danger); }

    .pn-grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px) { .pn-grid { grid-template-columns: 1fr 1fr; } }

    .pn-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .pn-card h3 { margin: 0 0 6px; font-size: 14px; color: var(--fg); }

    .pn-row { display:flex; align-items:center; justify-content:space-between; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(34,40,54,.7); }
    .pn-row:last-child { border-bottom: 0; }
    .pn-k { color: var(--muted); font-size: 12px; }
    .pn-v { color: var(--fg); font-size: 12px; text-align:right; }

    .pn-list {
      max-height: 260px;
      overflow: auto;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(34,40,54,.7);
      border-radius: 12px;
      padding: 10px;
      font-size: 12px;
      color: var(--fg);
    }
    .pn-list .muted { color: var(--muted); }

    .pn-msg { margin-top: 10px; font-size: 12px; color: var(--muted); }
    .pn-msg.ok { color: var(--accent); }
    .pn-msg.err { color: var(--danger); }

    .pn-mini-links {
      display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;
    }
    .pn-chip {
      border: 1px solid rgba(34,40,54,.9);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      text-decoration: none;
    }
    .pn-chip:hover { color: var(--fg); border-color: rgba(110,231,183,.6); }

    footer.weall-footer {
      margin-top: 18px;
      border-top: 1px solid rgba(34,40,54,.8);
      padding: 14px 2px 0;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }
    footer.weall-footer a { color: var(--muted); text-decoration: none; }
    footer.weall-footer a:hover { text-decoration: underline; color: var(--fg); }
  </style>
</head>

<body>
  <div id="weall_nav"></div>

  <div class="pn-shell">
    <div class="pn-head">
      <div>
        <h1 class="pn-title">Node Panel</h1>
        <p class="pn-sub">
          Unified diagnostics for readiness, chain, peers, pins, rewards + treasury.
          WebRTC + onboarding panels were removed here because the backend snapshot doesn’t expose those routes yet.
        </p>
        <div class="pn-pill" id="pnIdentityPill" title="Session">
          <span class="pn-dot warn" id="pnIdentityDot"></span>
          <span id="pnIdentityText">Checking session…</span>
        </div>
      </div>

      <div class="pn-actions">
        <button class="pn-btn primary" id="btnRefreshAll">Refresh all</button>
        <a class="pn-btn" href="/frontend/index.html">← Back to feed</a>
      </div>
    </div>

    <div class="pn-mini-links">
      <a class="pn-chip" href="/frontend/groups.html">Groups</a>
      <a class="pn-chip" href="/frontend/rewards.html">Rewards</a>
      <a class="pn-chip" href="/frontend/operator.html">Operator</a>
      <a class="pn-chip" href="/frontend/treasury.html">Treasury</a>
      <a class="pn-chip" href="/frontend/validators.html">Validators</a>
      <a class="pn-chip" href="/frontend/profile.html">Profile</a>
    </div>

    <div class="pn-grid" style="margin-top:12px;">
      <!-- Node meta -->
      <section class="pn-card">
        <h3>Node meta</h3>
        <div class="pn-row"><div class="pn-k">Node kind</div><div class="pn-v" id="nodeKind">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Node id</div><div class="pn-v" id="nodeId">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Network</div><div class="pn-v" id="nodeNetwork">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Version</div><div class="pn-v" id="nodeVersion">Loading…</div></div>
        <div class="pn-list" id="nodeMetaBox" style="margin-top:10px;">Loading…</div>
        <div class="pn-msg" id="nodeMetaMsg"></div>
      </section>

      <!-- Readiness -->
      <section class="pn-card">
        <h3>Readiness</h3>
        <div class="pn-row"><div class="pn-k">IPFS</div><div class="pn-v" id="ipfsReady">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">P2P</div><div class="pn-v" id="p2pReady">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Ledger</div><div class="pn-v" id="ledgerReady">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Overall</div><div class="pn-v" id="overallReady">Loading…</div></div>
        <div class="pn-list" id="readyBox" style="margin-top:10px;">Loading…</div>
        <div class="pn-msg" id="readyMsg"></div>
      </section>

      <!-- Chain -->
      <section class="pn-card">
        <h3>Chain</h3>
        <div class="pn-row"><div class="pn-k">Height</div><div class="pn-v" id="chainHeight">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Epoch</div><div class="pn-v" id="chainEpoch">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Bootstrap mode</div><div class="pn-v" id="chainBootstrap">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Epoch reward</div><div class="pn-v" id="chainEpochReward">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Next halving ETA</div><div class="pn-v" id="chainHalvingEta">Loading…</div></div>
        <div class="pn-list" id="chainBox" style="margin-top:10px;">Loading…</div>
        <div class="pn-msg" id="chainMsg"></div>
      </section>

      <!-- P2P Peers -->
      <section class="pn-card">
        <h3>P2P peers</h3>
        <div class="pn-row"><div class="pn-k">Peer count</div><div class="pn-v" id="peerCount">Loading…</div></div>
        <div class="pn-list" id="peerBox" style="margin-top:10px;">Loading…</div>
        <div class="pn-msg" id="peerMsg"></div>
      </section>

      <!-- Pins -->
      <section class="pn-card">
        <h3>IPFS pins</h3>
        <div class="pn-row"><div class="pn-k">Pin count</div><div class="pn-v" id="pinCount">Loading…</div></div>
        <div class="pn-list" id="pinBox" style="margin-top:10px;">Loading…</div>
        <div class="pn-msg" id="pinMsg"></div>
      </section>

      <!-- Rewards + Treasury -->
      <section class="pn-card">
        <h3>Rewards & treasury</h3>
        <div class="pn-row"><div class="pn-k">Token</div><div class="pn-v" id="tokenSymbol">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Block interval</div><div class="pn-v" id="blockInterval">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Epoch length</div><div class="pn-v" id="epochLength">Loading…</div></div>
        <div class="pn-row"><div class="pn-k">Treasury pools</div><div class="pn-v" id="treasuryPoolCount">Loading…</div></div>

        <div class="pn-list" id="rtBox" style="margin-top:10px;">Loading…</div>
        <div class="pn-msg" id="rtMsg"></div>

        <div class="pn-mini-links">
          <a class="pn-chip" href="/frontend/rewards.html">Open Rewards</a>
          <a class="pn-chip" href="/frontend/treasury.html">Open Treasury</a>
        </div>
      </section>
    </div>

    <footer class="weall-footer">
      <span>© <span id="footer-year">2024</span> WeAll</span>
      &nbsp;•&nbsp;<a href="/frontend/privacy.html">Privacy</a>
      &nbsp;•&nbsp;<a href="/frontend/terms.html">Terms</a>
    </footer>
  </div>

  <script src="/frontend/session.js"></script>
  <script src="/frontend/nav.js"></script>
  <script src="/frontend/footer.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    function setMsg(id, text, kind) {
      const el = $(id);
      if (!el) return;
      el.className = "pn-msg" + (kind ? " " + kind : "");
      el.textContent = text || "";
    }

    function setIdentity(text, dotKind) {
      const dot = $("pnIdentityDot");
      const el = $("pnIdentityText");
      if (el) el.textContent = text || "";
      if (dot) dot.className = "pn-dot " + (dotKind || "warn");
    }

    function pretty(obj) {
      try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
    }

    function secondsToHuman(sec) {
      const s = Math.max(0, Math.floor(sec || 0));
      if (s < 60) return s + "s";
      const m = Math.floor(s / 60);
      if (m < 60) return m + "m";
      const h = Math.floor(m / 60);
      if (h < 48) return h + "h";
      const d = Math.floor(h / 24);
      return d + "d";
    }

    async function authedJson(path, opts = {}) {
      const sess = await weallGetSession();
      const headers = Object.assign(
        { "Accept": "application/json" },
        opts.headers || {},
        (sess && sess.user_id) ? { "X-WeAll-User": sess.user_id } : {}
      );

      const res = await fetch(path, Object.assign({ credentials: "include", headers }, opts));
      let data = null;
      try { data = await res.json(); } catch { data = null; }
      if (!res.ok) {
        const msg = (data && (data.detail || data.error || data.message)) || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return data;
    }

    async function ensureSessionOrRedirect() {
      const sess = await weallGetSession();
      if (!sess || !sess.user_id) {
        setIdentity("Not signed in.", "fail");
        window.location.href = "/frontend/login.html";
        return null;
      }

      // best-effort PoH tier for the banner
      let tier = 0;
      try {
        const me = await authedJson("/poh/me", { method: "GET" });
        tier = Number(me && me.tier) || 0;
      } catch { tier = 0; }

      setIdentity(`Signed in as ${sess.user_id} · PoH Tier ${tier}`, "ok");
      return sess;
    }

    async function loadNodeMeta() {
      $("nodeKind").textContent = "Loading…";
      $("nodeId").textContent = "Loading…";
      $("nodeNetwork").textContent = "Loading…";
      $("nodeVersion").textContent = "Loading…";
      $("nodeMetaBox").textContent = "Loading…";
      setMsg("nodeMetaMsg", "", "");

      try {
        const meta = await authedJson("/node/meta", { method: "GET" });
        $("nodeKind").textContent = String(meta.node_kind ?? "—");
        $("nodeId").textContent = String(meta.node_id ?? "—");
        $("nodeNetwork").textContent = String(meta.network ?? "—");
        $("nodeVersion").textContent = String(meta.version ?? "—");
        $("nodeMetaBox").textContent = pretty(meta);
        setMsg("nodeMetaMsg", "OK", "ok");
      } catch (e) {
        $("nodeKind").textContent = "—";
        $("nodeId").textContent = "—";
        $("nodeNetwork").textContent = "—";
        $("nodeVersion").textContent = "—";
        $("nodeMetaBox").textContent = "Failed to load /node/meta";
        setMsg("nodeMetaMsg", e.message || "Failed", "err");
      }
    }

    async function loadReady() {
      $("ipfsReady").textContent = "Loading…";
      $("p2pReady").textContent = "Loading…";
      $("ledgerReady").textContent = "Loading…";
      $("overallReady").textContent = "Loading…";
      $("readyBox").textContent = "Loading…";
      setMsg("readyMsg", "", "");

      let ready = null;
      try {
        ready = await authedJson("/ops/ready", { method: "GET" });
      } catch (e) {
        $("readyBox").textContent = "Failed to load /ops/ready";
        setMsg("readyMsg", e.message || "Failed", "err");
        $("ipfsReady").textContent = "—";
        $("p2pReady").textContent = "—";
        $("ledgerReady").textContent = "—";
        $("overallReady").textContent = "—";
        return;
      }

      const ipfsOk = !!(ready && ready.ipfs && ready.ipfs.ok);
      const p2pOk = !!(ready && ready.p2p && ready.p2p.ok);
      const ledgerOk = !!(ready && ready.ledger && ready.ledger.ok);
      const ok = !!ready.ok;

      $("ipfsReady").textContent = ipfsOk ? "OK" : "Not ready";
      $("p2pReady").textContent = p2pOk ? "OK" : "Not ready";
      $("ledgerReady").textContent = ledgerOk ? "OK" : "Not ready";
      $("overallReady").textContent = ok ? "OK" : "Not ready";
      $("readyBox").textContent = pretty(ready);

      // Optional health summary (won't break if missing)
      try {
        const summary = await authedJson("/api/health/summary", { method: "GET" });
        $("readyBox").textContent = pretty({ ops_ready: ready, api_health_summary: summary });
      } catch { /* ignore */ }

      setMsg("readyMsg", ok ? "Node looks ready." : "Node is not fully ready yet.", ok ? "ok" : "err");
    }

    async function loadChain() {
      $("chainHeight").textContent = "Loading…";
      $("chainEpoch").textContent = "Loading…";
      $("chainBootstrap").textContent = "Loading…";
      $("chainEpochReward").textContent = "Loading…";
      $("chainHalvingEta").textContent = "Loading…";
      $("chainBox").textContent = "Loading…";
      setMsg("chainMsg", "", "");

      const out = {};

      try {
        const meta = await authedJson("/consensus/meta", { method: "GET" });
        out.consensus_meta = meta;
        $("chainHeight").textContent = String(meta.height ?? "0");
        $("chainEpoch").textContent = String(meta.epoch ?? "0");
        $("chainBootstrap").textContent = meta.bootstrap_mode ? "true" : "false";
      } catch (e) {
        setMsg("chainMsg", "Consensus meta unavailable: " + (e.message || ""), "err");
        $("chainHeight").textContent = "—";
        $("chainEpoch").textContent = "—";
        $("chainBootstrap").textContent = "—";
      }

      try {
        const tok = await authedJson("/chain/tokenomics", { method: "GET" });
        out.tokenomics = tok;
        $("chainEpochReward").textContent = String(tok.total_epoch_reward ?? "—");
        $("chainHalvingEta").textContent = secondsToHuman(tok.next_halving_in_seconds);
      } catch (e) {
        $("chainEpochReward").textContent = "—";
        $("chainHalvingEta").textContent = "—";
      }

      $("chainBox").textContent = pretty(out);
      if (!out.consensus_meta && !out.tokenomics) setMsg("chainMsg", "Chain endpoints unavailable.", "err");
      else if (!$("chainMsg").textContent) setMsg("chainMsg", "OK", "ok");
    }

    async function loadPeers() {
      $("peerCount").textContent = "Loading…";
      $("peerBox").textContent = "Loading…";
      setMsg("peerMsg", "", "");

      try {
        const data = await authedJson("/p2p/peers", { method: "GET" });
        const peers = (data && data.peers) || [];
        $("peerCount").textContent = String(peers.length);

        if (!peers.length) {
          $("peerBox").innerHTML = '<div class="muted">No peers yet.</div>';
          setMsg("peerMsg", "0 peers", "");
          return;
        }

        $("peerBox").innerHTML = peers.map(p => {
          const id = (p && p.node_id) || "(unknown)";
          const addr = (p && p.addr) || "";
          const last = (p && p.last_seen) ? (" · last_seen=" + p.last_seen) : "";
          return `<div>• <span style="color:var(--accent)">${id}</span> <span class="muted">${addr}${last}</span></div>`;
        }).join("");

        setMsg("peerMsg", "OK", "ok");
      } catch (e) {
        $("peerCount").textContent = "—";
        $("peerBox").innerHTML = '<div class="muted">Unable to load peers.</div>';
        setMsg("peerMsg", e.message || "Failed", "err");
      }
    }

    async function loadPins() {
      $("pinCount").textContent = "Loading…";
      $("pinBox").textContent = "Loading…";
      setMsg("pinMsg", "", "");

      try {
        const data = await authedJson("/pin/list", { method: "GET" });
        let pins = (data && (data.pins || data.items || data.cids)) || [];
        let count = Number(data && (data.count ?? pins.length)) || 0;

        if (!Array.isArray(pins) && typeof pins === "object") {
          pins = Object.keys(pins);
          count = pins.length;
        }

        $("pinCount").textContent = String(count);

        if (!pins.length) {
          $("pinBox").innerHTML = '<div class="muted">No pins reported.</div>';
          setMsg("pinMsg", "0 pins", "");
          return;
        }

        $("pinBox").innerHTML = pins.slice(0, 400).map(item => {
          const cid = (typeof item === "string") ? item : (item && (item.cid || item.Key)) || JSON.stringify(item);
          return `<div>• <span style="color:var(--accent)">${cid}</span></div>`;
        }).join("");

        setMsg("pinMsg", "OK", "ok");
      } catch (e) {
        // Best-effort endpoint; if pin listing isn't wired, don't make the whole panel look broken.
        $("pinCount").textContent = "—";
        $("pinBox").innerHTML = '<div class="muted">Pin listing not available on this node yet.</div>';
        setMsg("pinMsg", "Optional endpoint unavailable: " + (e.message || ""), "");
      }
    }

    async function loadRewardsTreasury() {
      $("tokenSymbol").textContent = "Loading…";
      $("blockInterval").textContent = "Loading…";
      $("epochLength").textContent = "Loading…";
      $("treasuryPoolCount").textContent = "Loading…";
      $("rtBox").textContent = "Loading…";
      setMsg("rtMsg", "", "");

      const out = {};

      try {
        const meta = await authedJson("/rewards/meta", { method: "GET" });
        out.rewards_meta = meta;
        $("tokenSymbol").textContent = String(meta.token_symbol ?? "—");
        $("blockInterval").textContent = String(meta.block_interval_seconds ?? "—") + "s";
        $("epochLength").textContent = String(meta.epoch_length_seconds ?? "—") + "s";
      } catch (e) {
        $("tokenSymbol").textContent = "—";
        $("blockInterval").textContent = "—";
        $("epochLength").textContent = "—";
      }

      try {
        const tmeta = await authedJson("/treasury/meta", { method: "GET" });
        const pools = await authedJson("/treasury/pools", { method: "GET" });
        out.treasury_meta = tmeta;
        out.treasury_pools = pools;

        const poolObj = pools && (pools.pools || pools);
        const poolCount = poolObj && typeof poolObj === "object" ? Object.keys(poolObj).length : 0;
        $("treasuryPoolCount").textContent = String(poolCount);
      } catch (e) {
        $("treasuryPoolCount").textContent = "—";
      }

      // Optional: membership pools
      try {
        const lp = await authedJson("/ledger/pools", { method: "GET" });
        out.ledger_pools = lp;
      } catch { /* ignore */ }

      $("rtBox").textContent = pretty(out);
      setMsg("rtMsg", "OK", "ok");
    }

    async function refreshAll() {
      await loadNodeMeta();
      await loadReady();
      await loadChain();
      await loadPeers();
      await loadPins();
      await loadRewardsTreasury();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const sess = await ensureSessionOrRedirect();
      if (!sess) return;

      $("btnRefreshAll").addEventListener("click", refreshAll);
      await refreshAll();
    });
  </script>
</body>
</html>
