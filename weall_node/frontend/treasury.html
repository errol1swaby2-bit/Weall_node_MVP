<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WeAll · Treasury</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Global app styles -->
  <link rel="stylesheet" href="/frontend/style.css" />

  <style>
    /* Page-specific tweaks on top of style.css */

    body {
      background-color: #020617;
      color: #e5e7eb;
    }

    .treasury-shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
    }

    .treasury-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 768px) {
      .treasury-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: baseline;
      }
    }

    .treasury-title {
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .treasury-subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      max-width: 420px;
    }

    .signed-in-banner {
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .signed-in-banner strong {
      font-weight: 600;
    }

    .treasury-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 1.25rem;
    }

    @media (max-width: 900px) {
      .treasury-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(168, 85, 247, 0.08), transparent 55%),
                  rgba(15, 23, 42, 0.95);
      padding: 1rem 1rem 1.25rem;
      backdrop-filter: blur(12px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.5rem;
    }

    .card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .card-pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #cbd5f5;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.86rem;
      margin-top: 0.35rem;
    }

    .metric-key {
      color: #9ca3af;
    }

    .metric-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
      color: #e5e7eb;
    }

    .metric-tagline {
      margin-top: 0.4rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .treasury-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .btn {
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
    }

    .btn-primary {
      border-color: rgba(56, 189, 248, 0.7);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.95));
      color: #ecfeff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .treasury-footnote {
      margin-top: 1.25rem;
      font-size: 0.75rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="treasury-shell">
    <header class="treasury-header">
      <div>
        <h1 class="treasury-title">Network Treasury</h1>
        <p class="treasury-subtitle">
          Protocol-level view of pooled WeCoin flows &amp; epoch rewards
          across Validators, Operators, Jurors, Creators, and Commons.
        </p>
      </div>

      <!-- Shared, spec-compliant typography banner -->
      <p id="signedIn" class="signed-in-banner">
        Loading session…
      </p>
    </header>

    <main>
      <section class="treasury-grid" id="treasuryRoot">
        <!-- Left: network-level metrics -->
        <div class="card" id="networkTreasuryCard">
          <div class="card-header">
            <h2 class="card-title">Global Pools</h2>
            <span class="card-pill">Epoch Snapshot</span>
          </div>

          <div class="metric-row">
            <span class="metric-key">Current epoch</span>
            <span class="metric-value" id="metricEpoch">–</span>
          </div>
          <div class="metric-row">
            <span class="metric-key">Block height</span>
            <span class="metric-value" id="metricHeight">–</span>
          </div>
          <div class="metric-row">
            <span class="metric-key">GSM / Genesis mode</span>
            <span class="metric-value" id="metricBootstrap">–</span>
          </div>

          <div class="metric-row">
            <span class="metric-key">Validators pool</span>
            <span class="metric-value" id="metricValidatorsPool">–</span>
          </div>
          <div class="metric-row">
            <span class="metric-key">Operators pool</span>
            <span class="metric-value" id="metricOperatorsPool">–</span>
          </div>
          <div class="metric-row">
            <span class="metric-key">Jurors pool</span>
            <span class="metric-value" id="metricJurorsPool">–</span>
          </div>
          <div class="metric-row">
            <span class="metric-key">Creators pool</span>
            <span class="metric-value" id="metricCreatorsPool">–</span>
          </div>
          <div class="metric-row">
            <span class="metric-key">Treasury / Commons</span>
            <span class="metric-value" id="metricCommonsPool">–</span>
          </div>

          <p class="metric-tagline">
            Pool splits and epoch rewards are defined at the protocol
            level and can only be changed via governance proposals.
          </p>

          <div class="treasury-actions">
            <button class="btn-primary btn" id="btnRefreshTreasury">
              Refresh snapshot
            </button>
            <button class="btn btn" id="btnViewEvents">
              View epoch events
            </button>
          </div>
        </div>

        <!-- Right: your position / eligibility -->
        <div class="card" id="roleEligibilityCard">
          <div class="card-header">
            <h2 class="card-title">Your Reward Tracks</h2>
            <span class="card-pill" id="pillTier">Tier –</span>
          </div>

          <div class="metric-row">
            <span class="metric-key">Reward-eligible pools</span>
            <span class="metric-value" id="metricEligiblePools">–</span>
          </div>

          <div class="metric-row">
            <span class="metric-key">Juror / dispute track</span>
            <span class="metric-value" id="metricJurorTrack">–</span>
          </div>

          <div class="metric-row">
            <span class="metric-key">Creator track</span>
            <span class="metric-value" id="metricCreatorTrack">–</span>
          </div>

          <div class="metric-row">
            <span class="metric-key">Operator / validator track</span>
            <span class="metric-value" id="metricOpValTrack">–</span>
          </div>

          <p class="metric-tagline">
            Eligibility is derived from your PoH tier, juror history,
            creator status, and node role. Opt in or out of any track
            from your profile and node settings.
          </p>

          <div class="treasury-actions">
            <button class="btn btn" id="btnGoProfile">
              Open profile
            </button>
            <button class="btn btn" id="btnGoGovernance">
              Go to governance
            </button>
          </div>
        </div>
      </section>

      <p class="treasury-footnote">
        This is a Genesis reference view. Exact numbers and reward
        draws are tracked in the on-chain WeCoin ledger and can be
        independently verified from any validator node.
      </p>
    </main>
  </div>

  <!-- Canonical script stack for app pages -->
  <script src="/frontend/env.js"></script>
  <script src="/frontend/auth.js"></script>
  <script src="/frontend/nav.js"></script>

  <script>
    async function fetchJson(url, opts) {
      const res = await fetch(url, opts || {});
      if (!res.ok) {
        const text = await res.text();
        throw new Error("HTTP " + res.status + " for " + url + ": " + text);
      }
      return res.json();
    }

    function buildRoleBanner(userId, roles, nodeMeta) {
      const parts = [];

      const tier = (roles && (roles.poh_tier ?? roles.pohTier)) || 0;
      if (tier > 0) {
        parts.push("PoH Tier " + tier);
      } else {
        parts.push("Unverified");
      }

      const flags = (roles && roles.flags) || {};
      const caps = (roles && roles.capabilities) || [];

      const tags = [];
      if (flags.wants_creator || caps.includes("earn_creator_rewards")) tags.push("Creator");
      if (flags.wants_juror || caps.includes("serve_juror_panel")) tags.push("Juror");
      if (flags.wants_validator || caps.includes("validator_duties")) tags.push("Validator");
      if (flags.wants_operator || caps.includes("operator_duties")) tags.push("Operator");
      if (flags.wants_emissary || caps.includes("act_as_emissary")) tags.push("Emissary");

      if (tags.length) {
        parts.push(tags.join(" · "));
      }

      const nodeKind = (nodeMeta && nodeMeta.node_kind) || "public_gateway";
      if (nodeKind === "validator_node") {
        parts.push("Validator node");
      } else if (nodeKind === "private_node") {
        parts.push("Private node");
      } else {
        parts.push("Gateway node");
      }

      return "Signed in as " + userId + " · " + parts.join(" · ");
    }

    function formatSplit(poolSplit, key) {
      if (!poolSplit || typeof poolSplit[key] === "undefined") return "–";
      const frac = Number(poolSplit[key]);
      if (!Number.isFinite(frac) || frac <= 0) return "–";
      return (frac * 100).toFixed(1).replace(/\.0$/, "") + " %";
    }

    async function hydrateTreasuryPage() {
      const bannerEl = document.getElementById("signedIn");

      // 1) Basic auth: require Tier 2+ to view Treasury
      const sess = await weallAuth.require({
        minTier: 2,
        redirectToLogin: "/frontend/login.html",
      });

      if (!sess || !sess.user_id) {
        if (bannerEl) bannerEl.textContent = "Not signed in";
        return;
      }

      const userId = sess.user_id;

      // 2) Fetch roles + node meta + consensus meta
      const [roles, nodeMeta, consensus] = await Promise.all([
        fetchJson("/roles/effective/me", {
          headers: { "X-WeAll-User": userId },
        }),
        fetchJson("/node/meta"),
        fetchJson("/consensus/meta"),
      ]);

      if (bannerEl) {
        bannerEl.textContent = buildRoleBanner(userId, roles, nodeMeta);
      }

      // 3) Fill in network treasury metrics from node meta + consensus meta
      const heightEl = document.getElementById("metricHeight");
      const epochEl = document.getElementById("metricEpoch");
      const bootstrapEl = document.getElementById("metricBootstrap");

      if (heightEl) heightEl.textContent = String(consensus.height ?? nodeMeta.height ?? "–");
      if (epochEl) epochEl.textContent = String(consensus.epoch ?? 0);
      if (bootstrapEl) {
        const bs = Boolean(consensus.bootstrap_mode ?? nodeMeta.bootstrap_mode);
        bootstrapEl.textContent = bs ? "Active (GSM)" : "Inactive";
      }

      const split = nodeMeta.pool_split || {};
      const validatorsPoolEl = document.getElementById("metricValidatorsPool");
      const operatorsPoolEl = document.getElementById("metricOperatorsPool");
      const jurorsPoolEl = document.getElementById("metricJurorsPool");
      const creatorsPoolEl = document.getElementById("metricCreatorsPool");
      const commonsPoolEl = document.getElementById("metricCommonsPool");

      if (validatorsPoolEl) validatorsPoolEl.textContent = formatSplit(split, "validators");
      if (operatorsPoolEl) operatorsPoolEl.textContent = formatSplit(split, "operators");
      if (jurorsPoolEl) jurorsPoolEl.textContent = formatSplit(split, "jurors");
      if (creatorsPoolEl) creatorsPoolEl.textContent = formatSplit(split, "creators");
      if (commonsPoolEl) commonsPoolEl.textContent = formatSplit(split, "treasury");

      // 4) “Your reward tracks” — approximate from flags/capabilities and node kind
      const tier = (roles && (roles.poh_tier ?? roles.pohTier)) || 0;
      const flags = (roles && roles.flags) || {};
      const caps = (roles && roles.capabilities) || [];
      const nodeKind = (nodeMeta && nodeMeta.node_kind) || "public_gateway";

      const pillTier = document.getElementById("pillTier");
      if (pillTier) {
        pillTier.textContent = "Tier " + (tier || "0");
      }

      const eligiblePoolsEl = document.getElementById("metricEligiblePools");
      const jurorTrackEl = document.getElementById("metricJurorTrack");
      const creatorTrackEl = document.getElementById("metricCreatorTrack");
      const opValTrackEl = document.getElementById("metricOpValTrack");

      const eligible = [];

      if (flags.wants_validator || caps.includes("validator_duties") || nodeKind === "validator_node") {
        eligible.push("Validators");
      }
      if (flags.wants_operator || caps.includes("operator_duties")) {
        eligible.push("Operators");
      }
      if (flags.wants_juror || caps.includes("serve_juror_panel")) {
        eligible.push("Jurors");
      }
      if (flags.wants_creator || caps.includes("earn_creator_rewards")) {
        eligible.push("Creators");
      }
      // everyone contributes to Commons pool implicitly

      if (eligiblePoolsEl) {
        eligiblePoolsEl.textContent = eligible.length ? eligible.join(" · ") : "None selected yet";
      }

      if (jurorTrackEl) {
        if (tier >= 3 && (flags.wants_juror || caps.includes("serve_juror_panel"))) {
          jurorTrackEl.textContent = "Active (Tier 3 + opted in)";
        } else if (tier >= 3) {
          jurorTrackEl.textContent = "Available (Tier 3, not opted in)";
        } else {
          jurorTrackEl.textContent = "Locked (needs Tier 3)";
        }
      }

      if (creatorTrackEl) {
        if (flags.wants_creator || caps.includes("earn_creator_rewards")) {
          creatorTrackEl.textContent = "Active (earning creator tickets)";
        } else {
          creatorTrackEl.textContent = "Available (opt in from profile)";
        }
      }

      if (opValTrackEl) {
        const isValidatorNode = nodeKind === "validator_node";
        if (isValidatorNode) {
          opValTrackEl.textContent = "Active validator node";
        } else if (flags.wants_operator || caps.includes("operator_duties") || flags.wants_validator) {
          opValTrackEl.textContent = "Available (run validator / operator node)";
        } else {
          opValTrackEl.textContent = "Optional (node rewards opt-in)";
        }
      }

      // 5) Wire primary CTA buttons
      const refreshBtn = document.getElementById("btnRefreshTreasury");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          hydrateTreasuryPage().catch((err) => {
            console.error("Failed to refresh treasury snapshot", err);
            alert("Failed to refresh snapshot. Please try again.");
          });
        });
      }

      const eventsBtn = document.getElementById("btnViewEvents");
      if (eventsBtn) {
        eventsBtn.addEventListener("click", () => {
          window.location.href = "/frontend/state_export.html";
        });
      }

      const goProfileBtn = document.getElementById("btnGoProfile");
      if (goProfileBtn) {
        goProfileBtn.addEventListener("click", () => {
          window.location.href = "/frontend/profile.html";
        });
      }

      const goGovernanceBtn = document.getElementById("btnGoGovernance");
      if (goGovernanceBtn) {
        goGovernanceBtn.addEventListener("click", () => {
          window.location.href = "/frontend/governance.html";
        });
      }

      // 6) If the legacy page had a JS entrypoint (e.g., initTreasury),
      //    we call it here so nothing breaks.
      if (typeof window.initTreasury === "function") {
        try {
          window.initTreasury({ roles, nodeMeta, consensus, session: sess });
        } catch (e) {
          console.warn("initTreasury threw an error:", e);
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      hydrateTreasuryPage().catch((err) => {
        console.error("Failed to hydrate treasury page", err);
        const bannerEl = document.getElementById("signedIn");
        if (bannerEl) bannerEl.textContent = "Error loading session";
      });
    });
  </script>
</body>
</html>
