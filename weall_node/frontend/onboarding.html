<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Onboarding & Proof of Humanity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/frontend/favicon.svg" />
  <link rel="stylesheet" href="/frontend/style.css" />
  <style>
    body {
      margin: 0;
      padding: 1.2rem 1.1rem 1.6rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #22c55e22 0, #020617 55%, #020617 100%);
      color: #e5e7eb;
    }

    .wrap {
      max-width: 1040px;
      margin: 0 auto;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1.3rem;
    }

    .page-header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .page-header .sub {
      margin: 0.35rem 0 0;
      font-size: 0.86rem;
      color: #9ca3af;
      max-width: 520px;
    }

    .back-link {
      font-size: 0.82rem;
      color: #9ca3af;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }

    .signed-in-banner {
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
      text-align: right;
    }
    .signed-in-banner strong {
      font-weight: 600;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.3fr);
      gap: 1.1rem;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.16), transparent 50%),
        rgba(15,23,42,0.96);
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 1rem 1.05rem 1.2rem;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.92);
    }

    .card h2 {
      margin: 0 0 0.35rem;
      font-size: 0.96rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card p {
      margin: 0.15rem 0;
      font-size: 0.86rem;
      color: #cbd5f5;
    }

    .pill-small {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 0.12rem 0.55rem;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 0.4rem;
    }

    .pill-small .dot {
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      background: #22c55e;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 0.3rem;
      font-size: 0.86rem;
    }

    .metric-key {
      color: #9ca3af;
    }

    .metric-value {
      color: #e5e7eb;
      font-weight: 500;
    }

    .status {
      margin-top: 0.45rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #fb7185; }

    .btn-row {
      margin-top: 0.7rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.85);
      padding: 0.45rem 0.95rem;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      cursor: pointer;
    }

    .btn.primary {
      border-color: rgba(34,197,94,0.9);
      background: radial-gradient(circle at top left,
                  rgba(34,197,94,0.5), rgba(15,23,42,0.98));
      color: #ecfeff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    ul.tier-steps {
      margin: 0.5rem 0 0;
      padding-left: 1.1rem;
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    ul.tier-steps li {
      margin-bottom: 0.25rem;
    }

    .hint {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    footer.weall-footer {
      border-top: 1px solid rgba(31,41,55,0.9);
      padding: 0.75rem 0.1rem 1.1rem;
      margin-top: 1.6rem;
      font-size: 0.78rem;
      color: #6b7280;
      text-align: center;
    }

    footer.weall-footer a {
      color: #9ca3af;
      text-decoration: none;
    }

    footer.weall-footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="page-header">
      <a href="/frontend/index.html" class="back-link">&larr; Back to Feed</a>
      <div>
        <h1>Onboarding &amp; PoH</h1>
        <p class="sub">
          This page reflects your current Proof-of-Humanity (PoH) tier and
          explains how Tier&nbsp;1 → Tier&nbsp;2 → Tier&nbsp;3 unfold in the
          Genesis network. All checks run against your local node.
        </p>
      </div>
      <p id="signedIn" class="signed-in-banner">
        Checking session…
      </p>
    </header>

    <main>
      <!-- Left: live PoH status from backend -->
      <section class="card">
        <h2>Current PoH status</h2>
        <p>
          The node reports your active PoH record. In Genesis mode this is a
          simple record in the node’s ledger; in production this becomes a
          verifiable chain of decisions and liveness checks.
        </p>

        <div class="pill-small" id="tierPill">
          <span class="dot"></span>
          <span id="tierLabel">Tier –</span>
        </div>

        <div class="metric-row">
          <span class="metric-key">Tier</span>
          <span class="metric-value" id="metricTier">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-key">Status</span>
          <span class="metric-value" id="metricStatus">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-key">Last updated</span>
          <span class="metric-value" id="metricUpdated">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-key">Juror-eligible</span>
          <span class="metric-value" id="metricJurorEligible">–</span>
        </div>

        <div class="btn-row">
          <button class="btn primary" id="btnRefreshPoh">
            Refresh status
          </button>
          <button class="btn" id="btnOpenJuror">
            Open juror console
          </button>
        </div>

        <div class="status" id="pohStatus"></div>
      </section>

      <!-- Right: tier overview / education -->
      <section class="card">
        <h2>PoH tiers overview</h2>
        <p>
          All rewards and most governance powers in WeAll are gated behind
          Proof-of-Humanity. The tiers are intentionally slow and explicit
          to keep Sybil attacks expensive and human spam low.
        </p>

        <h3 style="margin-top:0.6rem;font-size:0.86rem;text-transform:uppercase;letter-spacing:0.08em;color:#e5e7eb;">
          Tier 1 — Account bootstrap
        </h3>
        <ul class="tier-steps">
          <li>Email-based account creation and basic liveness heuristics.</li>
          <li>Eligible to use the feed, messaging, and basic governance.</li>
          <li>Not yet eligible for juror or high-stakes roles.</li>
        </ul>

        <h3 style="margin-top:0.7rem;font-size:0.86rem;text-transform:uppercase;letter-spacing:0.08em;color:#e5e7eb;">
          Tier 2 — Asynchronous liveness
        </h3>
        <ul class="tier-steps">
          <li>Asynchronous video / selfie checks with rotating prompts.</li>
          <li>Enables participation in higher-value reward tracks.</li>
          <li>Can be orchestrated entirely by the node and juror panels.</li>
        </ul>

        <h3 style="margin-top:0.7rem;font-size:0.86rem;text-transform:uppercase;letter-spacing:0.08em;color:#e5e7eb;">
          Tier 3 — Juror-grade verification
        </h3>
        <ul class="tier-steps">
          <li>Live, multi-party juror verification with dispute history.</li>
          <li>Unlocks juror rewards, recovery panel work, and sensitive roles.</li>
          <li>Negative scores can eventually lock or delete the account.</li>
        </ul>

        <p class="hint">
          This MVP page is intentionally read-only: it mirrors your current
          PoH record. The actual Tier 2 / Tier 3 upgrade flows are mediated by
          the disputes &amp; recovery subsystems using the same node API.
        </p>
      </section>
    </main>

    <footer class="weall-footer">
      <span>© <span id="footer-year">2024</span> WeAll</span>
      &nbsp;•&nbsp;<a href="/frontend/privacy.html">Privacy</a>
      &nbsp;•&nbsp;<a href="/frontend/terms.html">Terms</a>
    </footer>
  </div>

  <script src="/frontend/env.js"></script>
  <script src="/frontend/auth.js"></script>
  <script src="/frontend/session.js"></script>
  <script src="/frontend/nav.js"></script>
  <script src="/frontend/footer.js"></script>
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      function apiBase() {
        return (window.ENV && window.ENV.VITE_API_BASE) || "";
      }

      async function jsonFetch(path, opts) {
        const url = apiBase() + path;
        const options = Object.assign(
          {
            headers: { Accept: "application/json" },
            credentials: "include",
          },
          opts || {}
        );
        if (options.body && typeof options.body !== "string") {
          options.headers["Content-Type"] =
            options.headers["Content-Type"] || "application/json";
          options.body = JSON.stringify(options.body);
        }
        const res = await fetch(url, options);
        let data = null;
        try {
          data = await res.json();
        } catch {
          data = null;
        }
        if (!res.ok) {
          const msg =
            (data && (data.detail || data.error || data.message)) ||
            "Request failed with " + res.status;
          throw new Error(msg);
        }
        return data;
      }

      function buildRoleBanner(userId, roles, nodeMeta, poh) {
        const parts = [];

        const tier =
          (roles && (roles.poh_tier ?? roles.pohTier)) ||
          (poh && typeof poh.tier === "number" ? poh.tier : 0) ||
          0;
        const status = (poh && poh.status) || "ok";

        parts.push("PoH Tier " + tier + " (" + status + ")");

        const flags = (roles && roles.flags) || {};
        const caps = (roles && roles.capabilities) || [];
        const tags = [];

        if (flags.wants_creator || caps.includes("earn_creator_rewards")) {
          tags.push("Creator");
        }
        if (flags.wants_juror || caps.includes("serve_juror_panel")) {
          tags.push("Juror");
        }
        if (flags.wants_validator || caps.includes("validator_duties")) {
          tags.push("Validator");
        }
        if (flags.wants_operator || caps.includes("operator_duties")) {
          tags.push("Operator");
        }
        if (flags.wants_emissary || caps.includes("act_as_emissary")) {
          tags.push("Emissary");
        }

        if (tags.length) {
          parts.push(tags.join(" · "));
        }

        const nodeKind = (nodeMeta && nodeMeta.node_kind) || "public_gateway";
        if (nodeKind === "validator_node") {
          parts.push("Validator node");
        } else if (nodeKind === "private_node") {
          parts.push("Private node");
        } else {
          parts.push("Gateway node");
        }

        return "Signed in as " + userId + " · " + parts.join(" · ");
      }

      async function hydrateHeaderAndPoh() {
        const bannerEl = $("signedIn");
        const statusEl = $("pohStatus");

        try {
          const sess = await weallAuth.getSession();
          if (!sess || !sess.user_id) {
            if (bannerEl) bannerEl.textContent = "Not signed in.";
            if (statusEl) {
              statusEl.textContent = "Please log in to see your PoH status.";
              statusEl.className = "status err";
            }
            return null;
          }

          const [poh, roles, nodeMeta] = await Promise.all([
            weallAuth.getPohMe().catch(() => null),
            jsonFetch("/roles/effective/me", {
              headers: { "X-WeAll-User": sess.user_id },
            }).catch(() => null),
            jsonFetch("/node/meta").catch(() => null),
          ]);

          if (bannerEl) {
            bannerEl.textContent = buildRoleBanner(
              sess.user_id,
              roles,
              nodeMeta,
              poh
            );
          }

          // Hydrate PoH card
          const tier = poh && typeof poh.tier === "number" ? poh.tier : 0;
          const pohStatus = (poh && poh.status) || "unknown";
          const updatedAt = poh && poh.updated_at
            ? new Date(poh.updated_at * 1000).toLocaleString()
            : "–";

          const metricTier = $("metricTier");
          const metricStatus = $("metricStatus");
          const metricUpdated = $("metricUpdated");
          const metricJuror = $("metricJurorEligible");
          const tierLabel = $("tierLabel");

          if (metricTier) metricTier.textContent = String(tier || "0");
          if (metricStatus) metricStatus.textContent = pohStatus;
          if (metricUpdated) metricUpdated.textContent = updatedAt;
          if (tierLabel) tierLabel.textContent = "Tier " + (tier || "0");

          const jurorEligible = tier >= 3 && pohStatus === "ok";
          if (metricJuror) {
            metricJuror.textContent = jurorEligible
              ? "Yes (Tier 3, status ok)"
              : "No (requires Tier 3 & good standing)";
          }

          if (statusEl) {
            statusEl.textContent = "Status from node /poh/me and roles profile.";
            statusEl.className = "status ok";
          }

          return { sess, poh, roles, nodeMeta };
        } catch (err) {
          console.error("hydrateHeaderAndPoh error:", err);
          if (bannerEl) bannerEl.textContent = "Unable to load session.";
          if (statusEl) {
            statusEl.textContent = "Failed to load PoH status: " + err.message;
            statusEl.className = "status err";
          }
          return null;
        }
      }

      function wireButtons() {
        const refreshBtn = $("btnRefreshPoh");
        const jurorBtn = $("btnOpenJuror");

        if (refreshBtn) {
          refreshBtn.addEventListener("click", () => {
            hydrateHeaderAndPoh();
          });
        }

        if (jurorBtn) {
          jurorBtn.addEventListener("click", () => {
            window.location.href = "/frontend/juror.html";
          });
        }
      }

      async function init() {
        // Require at least Tier 1 (basic account) to see onboarding details
        const ok = await weallAuth.require({
          minTier: 1,
          redirectToLogin: "/frontend/login.html",
        });
        if (!ok) return;

        wireButtons();
        await hydrateHeaderAndPoh();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
