<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WeAll – Account Recovery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/frontend/style.css">
  <script src="/frontend/env.js"></script>
  <script src="/frontend/auth.js"></script>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.6rem 1.1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #22c55e22 0, #020617 55%, #020617 100%);
      color: #e5e7eb;
    }
    .wrap {
      width: 100%;
      max-width: 620px;
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow:
        0 22px 60px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.3);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.25rem;
      letter-spacing: 0.02em;
    }
    .sub {
      margin: 0;
      font-size: 0.86rem;
      color: #9ca3af;
    }
    label {
      display: block;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    input, textarea {
      width: 100%;
      border-radius: 10px;
      padding: 9px 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.9rem;
      outline: none;
      resize: vertical;
    }
    input:focus, textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
    }
    .field {
      margin-top: 12px;
    }
    .field textarea {
      min-height: 110px;
    }
    .btn-row {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
    }
    .btn {
      border-radius: 999px;
      padding: 8px 13px;
      font-size: 0.88rem;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn.primary {
      border: none;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #020617;
      font-weight: 600;
      box-shadow: 0 16px 45px rgba(16, 185, 129, 0.8);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
    }
    .status {
      margin-top: 10px;
      font-size: 0.82rem;
      min-height: 1.2em;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }
    .hint {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    a {
      color: #22c55e;
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 2px 4px;
      background: rgba(15,23,42,0.9);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Account Recovery Request</h1>
    <p class="sub">
      This creates a recovery case that a juror panel can review. On approval, your
      Proof-of-Humanity identity will be rebound to a new account key.
    </p>

    <div class="field">
      <label for="userId">Your handle / user id</label>
      <input id="userId" placeholder="@yourname or yourname" />
    </div>

    <div class="field">
      <label for="newPk">New account public key (Ed25519 hex)</label>
      <input id="newPk" placeholder="e.g. 9f21ab… (public key only)" />
    </div>

    <div class="field">
      <label for="reason">Explain what happened</label>
      <textarea id="reason"
        placeholder="Describe how you lost access, how we can verify it's really you (e.g., prior activity, PoH details), and any extra context."
      ></textarea>
    </div>

    <div class="btn-row">
      <button class="btn primary" id="submitBtn">Submit recovery request</button>
      <a class="btn" href="/frontend/profile.html">Back to profile</a>
    </div>

    <div class="status" id="status"></div>

    <div class="hint">
      Once your case is created, you’ll see a <strong>case id</strong>.
      Jurors and governance tools can use that id to review and finalize your recovery.
    </div>
  </div>

  <script>
    (function () {
      const statusEl = document.getElementById("status");
      const userIdEl = document.getElementById("userId");
      const pkEl = document.getElementById("newPk");
      const reasonEl = document.getElementById("reason");
      const submitBtn = document.getElementById("submitBtn");

      function setStatus(msg, cls) {
        statusEl.textContent = msg || "";
        statusEl.className = "status" + (cls ? " " + cls : "");
      }

      function apiBase() {
        return (window.ENV && window.ENV.VITE_API_BASE) || "";
      }

      async function createRecovery(userId, newPk, reason) {
        const res = await fetch(apiBase() + "/recovery/request", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({
            user_id: userId,
            new_account_pk_hex: newPk,
            reason: reason
          })
        });
        let data = {};
        try { data = await res.json(); } catch {}
        if (!res.ok) {
          throw new Error(
            data.detail || data.error || data.message || ("Request failed with " + res.status)
          );
        }
        return data;
      }

      // Prefill user id from session if possible
      (async () => {
        try {
          const sess = await weallAuth.getSession();
          if (sess && sess.user_id) {
            userIdEl.value = sess.user_id;
          }
        } catch (e) {
          // not fatal
        }
      })();

      submitBtn.addEventListener("click", async () => {
        const userId = userIdEl.value.trim();
        const newPk = pkEl.value.trim();
        const reason = reasonEl.value.trim();

        if (!userId) {
          setStatus("Please enter your handle / user id.", "err");
          return;
        }
        if (!newPk) {
          setStatus("Please enter the new account public key (Ed25519 hex).", "err");
          return;
        }
        if (!reason) {
          setStatus("Please provide a short explanation.", "err");
          return;
        }

        submitBtn.disabled = true;
        setStatus("Submitting recovery request…");

        try {
          const data = await createRecovery(userId, newPk, reason);
          const caseId = data && data.case && data.case.case_id;
          if (!caseId) {
            setStatus("Recovery request created, but no case id returned.", "ok");
          } else {
            setStatus(
              "Recovery case created. Your case id is " +
              caseId +
              ". Save this for your records.",
              "ok"
            );
          }
        } catch (e) {
          setStatus("Failed to submit recovery request: " + e.message, "err");
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
