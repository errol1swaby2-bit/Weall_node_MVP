<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Disputes Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/frontend/style.css" />
  <script src="/frontend/env.js"></script>
  <script src="/frontend/auth.js"></script>
  <style>
    body {
      margin: 0;
      padding: 1.3rem 1.1rem 1.8rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #22c55e22 0, #020617 55%, #020617 100%);
      color: #e5e7eb;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 1.1rem;
    }
    .back-link {
      font-size: 0.8rem;
      color: #9ca3af;
      text-decoration: none;
    }
    .back-link:hover { text-decoration: underline; }
    h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.03em;
    }
    .sub {
      margin: 0.1rem 0 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .pill {
      border-radius: 999px;
      padding: 6px 11px;
      font-size: 0.8rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      cursor: pointer;
    }
    main {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 18px 50px rgba(15,23,42,0.9);
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 0.7rem;
    }
    .status {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.78rem;
    }
    select {
      border-radius: 999px;
      padding: 5px 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 0.78rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 0.6rem;
    }
    thead {
      background: rgba(15,23,42,0.9);
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }
    tr:hover {
      background: rgba(30,64,175,0.25);
      cursor: pointer;
    }
    td.case-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.74rem;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
    }
    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #64748b;
    }
    .dot.open { background: #22c55e; }
    .dot.decided { background: #f97373; }
    .empty {
      margin-top: 0.8rem;
      font-size: 0.84rem;
      color: #9ca3af;
    }
    a {
      color: #22c55e;
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <a href="/frontend/tiktok.html" class="back-link">&larr; Back to Feed</a>
        <h1>Disputes Overview</h1>
        <p class="sub" id="dispUser">Checking session…</p>
      </div>
      <button class="pill" id="jurorConsoleBtn">Open juror console</button>
    </header>

    <main>
      <div class="top-row">
        <div class="filters">
          <label>
            Type:
            <select id="filterType">
              <option value="">All</option>
              <option value="recovery">Recovery</option>
              <option value="content">Content</option>
              <option value="identity">Identity</option>
            </select>
          </label>
          <label>
            Status:
            <select id="filterStatus">
              <option value="">All</option>
              <option value="open">Open</option>
              <option value="decided">Decided</option>
            </select>
          </label>
        </div>
        <div class="status" id="dispStatus">Loading disputes…</div>
      </div>

      <div id="dispTableHost"></div>
    </main>
  </div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      function apiBase() {
        return (window.ENV && window.ENV.VITE_API_BASE) || "";
      }

      async function jsonFetch(path, opts) {
        const url = apiBase() + path;
        const options = Object.assign(
          {
            headers: { "Accept": "application/json" },
            credentials: "include",
          },
          opts || {}
        );
        if (options.body && typeof options.body !== "string") {
          options.headers["Content-Type"] =
            options.headers["Content-Type"] || "application/json";
          options.body = JSON.stringify(options.body);
        }
        const res = await fetch(url, options);
        let data = null;
        try { data = await res.json(); } catch {}
        if (!res.ok) {
          const msg =
            (data && (data.detail || data.error || data.message)) ||
            ("Request failed with " + res.status);
          throw new Error(msg);
        }
        return data;
      }

      function formatDate(ts) {
        if (!ts) return "";
        if (ts > 1e12) ts = ts / 1000;
        const d = new Date(ts * 1000);
        return d.toLocaleDateString() + " " + d.toLocaleTimeString();
      }

      function renderTable(cases) {
        const host = $("dispTableHost");
        if (!host) return;
        host.innerHTML = "";

        if (!cases || cases.length === 0) {
          const div = document.createElement("div");
          div.className = "empty";
          div.textContent = "No disputes recorded yet.";
          host.appendChild(div);
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        ["Case", "Type", "Subject", "Status", "Created", "Decided by"].forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        cases.forEach((rec) => {
          const tr = document.createElement("tr");
          tr.onclick = () => {
            const url =
              "/frontend/juror.html?case_id=" + encodeURIComponent(rec.case_id);
            window.location.href = url;
          };

          const tdId = document.createElement("td");
          tdId.textContent = rec.case_id;
          tdId.className = "case-id";
          tr.appendChild(tdId);

          const tdType = document.createElement("td");
          tdType.textContent = rec.case_type || "–";
          tr.appendChild(tdType);

          const tdSubject = document.createElement("td");
          tdSubject.textContent = rec.subject_user_id || "–";
          tr.appendChild(tdSubject);

          const tdStatus = document.createElement("td");
          const badge = document.createElement("span");
          badge.className = "badge";
          const dot = document.createElement("span");
          dot.className = "dot " + (rec.status === "open" ? "open" : "decided");
          const label = document.createElement("span");
          label.textContent = rec.status || "unknown";
          badge.appendChild(dot);
          badge.appendChild(label);
          tdStatus.appendChild(badge);
          tr.appendChild(tdStatus);

          const tdCreated = document.createElement("td");
          tdCreated.textContent = formatDate(rec.created_at);
          tr.appendChild(tdCreated);

          const tdDecidedBy = document.createElement("td");
          tdDecidedBy.textContent = rec.decided_by || "–";
          tr.appendChild(tdDecidedBy);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        host.appendChild(table);
      }

      function applyFilters(allCases) {
        const typeSel = $("filterType");
        const statusSel = $("filterStatus");
        const tVal = typeSel ? typeSel.value : "";
        const sVal = statusSel ? statusSel.value : "";

        return allCases.filter((rec) => {
          if (tVal && (rec.case_type || "") !== tVal) return false;
          if (sVal && (rec.status || "") !== sVal) return false;
          return true;
        });
      }

      async function loadDisputes() {
        const statusEl = $("dispStatus");
        if (statusEl) {
          statusEl.textContent = "Loading disputes…";
        }

        try {
          const data = await jsonFetch("/health/ledger/disputes", {
            method: "GET",
          });
          const dispNs = data && data.data;
          const casesObj = (dispNs && dispNs.cases) || {};
          const all = Object.values(casesObj);
          if (statusEl) {
            statusEl.textContent = all.length + " cases in ledger.";
          }

          const filtered = applyFilters(all);
          renderTable(filtered);

          const typeSel = $("filterType");
          const statusSel = $("filterStatus");
          if (typeSel) typeSel.onchange = () => renderTable(applyFilters(all));
          if (statusSel) statusSel.onchange = () => renderTable(applyFilters(all));
        } catch (e) {
          if (statusEl) {
            statusEl.textContent = "Failed to load disputes: " + e.message;
          }
          renderTable([]);
        }
      }

      async function hydrateHeader() {
        const el = $("dispUser");
        if (!el) return;
        try {
          const sess = await weallAuth.getSession();
          if (!sess || !sess.user_id) {
            el.textContent = "Not signed in.";
            return;
          }
          const poh = await weallAuth.getPohMe().catch(() => null);
          const tier = poh && typeof poh.tier === "number" ? poh.tier : 0;
          const status = poh && poh.status ? poh.status : "ok";
          el.textContent =
            "Signed in as " + sess.user_id + " · PoH Tier " + tier + " (" + status + ")";
        } catch {
          el.textContent = "Unable to load session.";
        }
      }

      async function init() {
        // Gate: Tier-3 required
        const ok = await weallAuth.require({
          minTier: 3,
          redirectToLogin: "/frontend/login.html",
        });
        if (!ok) return;

        const jurorBtn = $("jurorConsoleBtn");
        const logoutBtn = $("logoutBtn"); // might exist in style.css layout or not
        if (jurorBtn) {
          jurorBtn.onclick = () => {
            window.location.href = "/frontend/juror.html";
          };
        }
        if (logoutBtn) {
          logoutBtn.onclick = async () => {
            await weallAuth.logout();
            window.location.replace("/frontend/login.html");
          };
        }

        await hydrateHeader();
        await loadDisputes();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
