<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WeAll — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/frontend/favicon.svg" />
  <link rel="stylesheet" href="/frontend/style.css?v=1762461479" />\n  <script src="/frontend/session.js"></script>

  <style>
    .step { display: none; }
    .step.active { display: block; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    #status { margin-top: 10px; font-size: 13px; }
    #status.ok { color: #7dd47d; }
    #status.error { color: #ff8a8a; }
  </style>
</head>
<body>
  <div id="toast" role="status" aria-live="polite"></div>
  <main style="min-height:100dvh;display:grid;place-items:center;padding:24px">
    <div class="wa-card" style="width:min(560px,92vw)">
      <h2 style="margin:0 0 8px 0">Welcome</h2>
      <p class="wa-dim" style="margin:0 0 14px 0">
        Enter your email, get a 6-digit code, verify, and we’ll log you in.
      </p>

      <!-- Step 1: enter email → send code -->
      <section id="step1" class="step active">
        <label class="wa-labelblock">
          Email
          <input id="email" name="email" type="email" autocomplete="email"
                 placeholder="you@example.com" maxlength="254" required>
        </label>
        <div class="wa-row" style="margin-top:10px">
          <button class="wa-btn" id="btnSend">Send code</button>
        </div>
        <div class="hint">We’ll email a 6-digit code to verify this address.</div>
      </section>

      <!-- Step 2: enter OTP → verify -->
      <section id="step2" class="step">
        <div class="wa-row" style="align-items:flex-end">
          <label class="wa-labelblock" style="flex:1">Enter code
            <input id="code" name="code" type="text" inputmode="numeric"
                   pattern="\d{6}" maxlength="6" placeholder="123456">
          </label>
          <button class="wa-btn wa-ghost" id="btnResend" title="Resend code">Resend</button>
        </div>
        <div class="wa-row" style="margin-top:8px">
          <button class="wa-btn" id="btnVerify">Verify & Continue</button>
        </div>
      </section>

      <div id="status"></div>

      <p class="wa-dim" style="font-size:12px;margin-top:12px">
        Private keys and advanced setup will be handled after login.
      </p>
    </div>
  </main>

  <script>
    (function () {
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const emailInput = document.getElementById('email');
      const codeInput = document.getElementById('code');
      const btnSend = document.getElementById('btnSend');
      const btnResend = document.getElementById('btnResend');
      const btnVerify = document.getElementById('btnVerify');
      const statusEl = document.getElementById('status');

      let currentEmail = '';

      function showStep(n) {
        step1.classList.toggle('active', n === 1);
        step2.classList.toggle('active', n === 2);
      }

      function setStatus(msg, kind) {
        statusEl.textContent = msg || '';
        statusEl.className = '';
        if (kind) statusEl.classList.add(kind);
      }

      async function postJson(url, body) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        let data = {};
        try { data = await res.json(); } catch (_) {}
        if (!res.ok || data.error || data.detail) {
          const msg = data.detail || data.error || (res.status + ' ' + res.statusText);
          throw new Error(msg);
        }
        return data;
      }

      async function sendCode() {
        const email = (emailInput.value || '').trim();
        if (!email) {
          setStatus('Please enter your email.', 'error');
          return;
        }
        try {
          setStatus('Sending code…');
          await postJson('/auth/start', { email });
          currentEmail = email;
          localStorage.setItem('weall_email', email);
          setStatus('Code sent to ' + email + '. Check your inbox.', 'ok');
          showStep(2);
          codeInput.focus();
        } catch (e) {
          setStatus('Failed to send code: ' + e.message, 'error');
        }
      }

      async function resendCode() {
        const email = currentEmail || (emailInput.value || '').trim();
        if (!email) {
          setStatus('No email to resend to. Please start over.', 'error');
          showStep(1);
          return;
        }
        try {
          setStatus('Resending code…');
          await postJson('/auth/start', { email });
          setStatus('Code resent to ' + email + '.', 'ok');
        } catch (e) {
          setStatus('Failed to resend code: ' + e.message, 'error');
        }
      }

      async function verifyCode() {
        const email = currentEmail || (emailInput.value || '').trim();
        const code  = (codeInput.value || '').trim();
        if (!email) {
          setStatus('Email is required.', 'error');
          return;
        }
        if (!/^\d{6}$/.test(code)) {
          setStatus('Enter the 6-digit code.', 'error');
          return;
        }
        try {
          setStatus('Verifying…');
          const res = await postJson('/auth/verify', { email, code });
          if (res && (res.ok === true || res.token || res.message)) {
            setStatus('Verified. Creating session…', 'ok');
            try {
              // Issue a signed session token (Session.js)
              if (window.Session && typeof Session.login === 'function') {
                const sess = await Session.login(email);
                try {
                  if (sess && sess.token) {
                    // Legacy flag so older guards keep working
                    localStorage.setItem('weall_token', sess.token);
                  }
                } catch (_) {}
              }
              // Normalize account / user identifiers for downstream pages
              try {
                localStorage.setItem('weall.account', email);
                localStorage.setItem('weall_acct', email);
                localStorage.setItem('weall_user', email);
                if (!localStorage.getItem('weall_poh')) {
                  localStorage.setItem('weall_poh', '1');
                }
                if (!localStorage.getItem('weall_nft')) {
                  localStorage.setItem('weall_nft', '0');
                }
              } catch (_) {}
            } catch (e) {
              console.warn('Session login failed (continuing anyway):', e);
            }

            // Decide where to go next (respect ?next= when safe)
            const qs = new URLSearchParams(location.search);
            let next = (window.__WEALL_SAFE_NEXT__ || qs.get('next') || '/frontend/index.html');

            // If next is URL-encoded like "%2F", decode it.
            try {
              next = decodeURIComponent(next);
            } catch (_) {}

            // Normalize unsafe or useless targets to the home feed
            if (!next ||
                next === '/' ||
                next === '/frontend/' ||
                next === '/frontend/login.html' ||
                next === location.origin + '/' ||
                next === location.origin) {
              next = '/frontend/index.html';
            }

            // Only allow absolute paths within this origin
            if (!next.startsWith('/')) next = '/frontend/index.html';

            setStatus('Verified. Redirecting…', 'ok');
            setTimeout(() => {
              window.location.replace(next);
            }, 150);
          } else {
            setStatus('Unexpected response from server.', 'error');
          }
        } catch (e) {
          setStatus('Verification failed: ' + e.message, 'error');
        }
      }

      // Wire buttons
      btnSend.addEventListener('click', (e) => { e.preventDefault(); sendCode(); });
      btnResend.addEventListener('click', (e) => { e.preventDefault(); resendCode(); });
      btnVerify.addEventListener('click', (e) => { e.preventDefault(); verifyCode(); });

      // Enter key on code field triggers verify
      codeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          verifyCode();
        }
      });

      // If we already have an email in storage, prefill
      (function prefill() {
        try {
          const savedEmail = localStorage.getItem('weall_email');
          if (savedEmail) {
            emailInput.value = savedEmail;
          }
        } catch (_) {}
      })();
    })();
  </script>
</body>
</html>
