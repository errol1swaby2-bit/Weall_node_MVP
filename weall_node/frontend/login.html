<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeAll — Sign In</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="/frontend/style.css" />
</head>
<body>
  <div id="weall_nav"></div>

  <main class="auth-shell">
    <div class="auth-card">
      <div class="auth-head">
        <div class="auth-badge"></div>
        <div>
          <div class="auth-kicker">WELCOME BACK</div>
          <h1 class="auth-title">SIGN IN TO WEALL</h1>
          <div class="auth-sub">Use your handle (e.g. <b>@satnak</b>) or email.</div>
        </div>
      </div>

      <form id="loginForm" class="auth-form" autocomplete="on">
        <label class="auth-label">HANDLE OR EMAIL</label>
        <input id="identifier" class="auth-input" placeholder="@yourhandle or email" autocomplete="username" />

        <label class="auth-label">PASSWORD</label>
        <input id="password" class="auth-input" type="password" placeholder="********" autocomplete="current-password" />

        <button class="auth-btn" type="submit">CONTINUE</button>

        <div id="msg" class="auth-msg" style="min-height:1.2em;"></div>

        <div class="auth-links">
          <a href="/frontend/signup.html">Create a new account</a>
          <span> · </span>
          <a href="/frontend/recover.html">Recover or reset access</a>
        </div>
      </form>
    </div>
  </main>

  <script src="/frontend/session.js"></script>
  <script src="/frontend/nav.js"></script>
  <script>
    // Kill any legacy query-string credential flow immediately
    const hadSensitiveQS = weallStripQueryIfSensitive();
    if (hadSensitiveQS) {
      const m = document.getElementById("msg");
      m.textContent = "For security, please re-enter your credentials.";
      m.style.color = "#ff6b6b";
    }

    function normalizeIdentifier(raw) {
      let s = (raw || "").trim();
      // If user accidentally types @email@gmail.com (two @), strip the leading @
      if (s.startsWith("@") && (s.match(/@/g) || []).length > 1) s = s.slice(1);
      // If it's a normal handle and they typed @satnak, that's fine.
      return s;
    }

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("msg");
      msg.textContent = "";

      const identifier = normalizeIdentifier(document.getElementById("identifier").value);
      const password = document.getElementById("password").value;

      try {
        await weallJsonFetch("/auth/apply", {
          method: "POST",
          body: JSON.stringify({ user_id: identifier, password })
        });
        window.location.href = "/frontend/index.html";
      } catch (err) {
        msg.textContent = err.message || "Login failed.";
        msg.style.color = "#ff6b6b";
      }
    });
  </script>
</body>
</html>
